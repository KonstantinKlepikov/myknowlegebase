<!DOCTYPE html>
<html lang="ru_RU">

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Celery | My knowledge base</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Celery" />
<meta property="og:locale" content="ru_RU" />
<meta name="description" content="Очереди задач в python с celery" />
<meta property="og:description" content="Очереди задач в python с celery" />
<link rel="canonical" href="https://konstantinklepikov.github.io/myknowlegebase/notes/celery.html" />
<meta property="og:url" content="https://konstantinklepikov.github.io/myknowlegebase/notes/celery.html" />
<meta property="og:site_name" content="My knowledge base" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://konstantinklepikov.github.io/myknowlegebase/notes/celery.html","headline":"Celery","description":"Очереди задач в python с celery","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="keywords" content="">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    
    
    <link rel="stylesheet" href="https://konstantinklepikov.github.io/myknowlegebase/assets/style.css">
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->


      <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(53548570, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/53548570" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
      <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139620627-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-139620627-1');
  </script>


<!-- Favicon -->
<link rel="icon" href="https://konstantinklepikov.github.io/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="https://konstantinklepikov.github.io/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">

<!-- Math support -->
<!-- Mathjax Support -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- tags collection-->

    







<!-- end custom head snippets -->

</head>

  <body>

    <header class="border-bottom-thick px-2 clearfix">
    <div class="left sm-width-full py-1 mt-1 mt-lg-0">
      <a class="align-middle link-primary text-accent" href="https://konstantinklepikov.github.io/">
        My deep learning
      </a>
    </div>
    <div class="right sm-width-full">
      <ul class="list-reset mt-lg-1 mb-2 mb-lg-1">
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/myknowlegebase/">
            My knowledge base
          </a>
        </li>
      </ul>
    </div>
  </header>

    <main role="main">

      
<article class="container mx-auto px-2 mt2 mb4">
  <header>
    <h1 class="h1 col-9 sm-width-full py-4 mt-3 inline-block" itemprop="name headline">Celery</h1>
  </header>
  <div class="col-4 sm-width-full border-top-thin">
    <p class="mb-3 h5">Теги:
      
        
        <a href="/myknowlegebase/tag/queue" title="queue" class="link-tags">queue&nbsp;</a>
      
        
        <a href="/myknowlegebase/tag/python" title="python" class="link-tags">python&nbsp;</a>
      
      </p>
  </div>
  <div class="prose mb-4 py-4">
    <h2 id="intro">Intro</h2>

<p><a href="https://docs.celeryproject.org/en/stable/">Celery</a> это простая, гибкая и надежная распределенная система для обработки большого количества сообщений, предоставляющая операции с инструментами, необходимыми для обслуживания такой системы.</p>

<p>Очереди используются как механизм для распределения работы по потокам или процессам.</p>

<p>Celery использует брокера для посредничества между клиентами и воркерами. Чтобы инициировать задачу, клиент добавляет сообщение в очередь, а затем брокер доставляет это сообщение воркеру.</p>

<p>Система Celery может состоять из нескольких воркеров и брокеров. Celery написан на python, но протокол может быть реализован на любом языке.</p>

<p>Простейший пример приложения.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'hello'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'amqp://guest@localhost//'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'hello world'</span>
</code></pre></div></div>

<p>Celery поддерживает:</p>

<ul>
  <li>brokers [<a href="redis" title="Redis">redis</a>], [<a href="rabbitmq" title="Rabbitmq">rabbitmq</a>], amazonsqs и <a href="https://docs.celeryproject.org/en/stable/getting-started/backends-and-brokers/index.html#brokers">т.д.</a></li>
  <li>совместная работа обеспечивается через multiprocessing, eventied, gevent, multithreading или solo threading реализации</li>
  <li>поддерживает хранилища: AMQP, Redis, Memcached, SQLAlchemy, Django ORM, Apache Cassandra, Elasticsearch, Riak, MongoDB, CouchDB, Couchbase, ArangoDB, Amazon DynamoDB, Amazon S3, Microsoft Azure Block Blob, Microsoft Azure Cosmos DB, file system</li>
  <li>сериализация: pickle, json, yaml, msgpack, zlib, bzip2, Cryptographic message signing.</li>
</ul>

<p>Фичи:</p>

<ul>
  <li>мониторинг событий</li>
  <li>планировщик задач</li>
  <li>планировщик рабочих процессов</li>
  <li>защита от утечки ресурсов</li>
  <li>установка лимитов по времени и скорости</li>
  <li>кастомизируемость</li>
</ul>

<p>Как инсталить <a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html#installation">смотри тут</a>. Там же весь набор бандлов для установки бекендов, сериализации, транспорта и т.д.</p>

<p><a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html#celery-is">introduction</a></p>

<h2 id="быстрый-запуск"><a href="https://docs.celeryproject.org/en/stable/getting-started/first-steps-with-celery.html#redis">Быстрый запуск</a></h2>

<ul>
  <li>Выбираем и ставим транспорт сообщений (брокер)</li>
  <li>ставим Celery и создаем первую задачу</li>
  <li>запуск воркера и вызываем задачу</li>
  <li>отслеживаем задачи по мере их перехода через разные состояния и првоеряем возвращаемые значения</li>
</ul>

<p>Брокеры: [<a href="rabbitmq" title="Rabbitmq">rabbitmq</a>] или [<a href="redis" title="Redis">redis</a>]</p>

<p>Для редиса можно черех [<a href="../lists/docker" title="Docker">docker</a>]: <code class="language-plaintext highlighter-rouge">docker run -d -p 6379:6379 redis</code></p>

<p>Ставим celery: <code class="language-plaintext highlighter-rouge">pip install celery</code></p>

<p><a href="https://docs.celeryproject.org/en/stable/getting-started/backends-and-brokers/redis.html#broker-redis">Ставим коннектор</a> для [<a href="redis" title="Redis">redis</a>]: <code class="language-plaintext highlighter-rouge">pip install -U "celery[redis]"</code></p>

<p>Пишем апку (в боевых условия нам конечно понадобится сконфигурировать <a href="https://docs.celeryproject.org/en/stable/getting-started/backends-and-brokers/redis.html#broker-redis">доступ к redis</a>, задав и указав логин/пароль)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'redis://localhost:6379/0'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div></div>

<p>Первым аргументом Celery является имя текущего модуля. Это нужно только для того, чтобы имена могли генерироваться автоматически, когда задачи определены в модуле <code class="language-plaintext highlighter-rouge">__main__</code>. Второй аргумент — это аргумент ключа брокера, указывающий URL-адрес брокера сообщений, который вы хотите использовать.</p>

<ul>
  <li>для rabbitmq <code class="language-plaintext highlighter-rouge">amqp://localhost</code></li>
  <li>для redis <code class="language-plaintext highlighter-rouge">redis://localhost</code></li>
</ul>

<p>Стартуема сервер из папки приложения: <code class="language-plaintext highlighter-rouge">celery -A tasks worker --loglevel=INFO</code> В данном случае сервак запускается в лоб. В реальности нужен демон - <a href="https://docs.celeryproject.org/en/stable/userguide/daemonizing.html#daemonizing">смотри тут</a></p>

<p>Тада:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">--------------</span> celery@pop-os v5.2.3 <span class="o">(</span>dawn-chorus<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span>
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> Linux-5.8.0-7630-generic-x86_64-with-glibc2.32 2022-01-17 23:32:33
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span>
- <span class="k">**</span> <span class="nt">----------</span> <span class="o">[</span>config]
- <span class="k">**</span> <span class="nt">----------</span> .&gt; app:         tasks:0x7fdfe7e14a60
- <span class="k">**</span> <span class="nt">----------</span> .&gt; transport:   redis://localhost:6379/0
- <span class="k">**</span> <span class="nt">----------</span> .&gt; results:     disabled://
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> .&gt; concurrency: 12 <span class="o">(</span>prefork<span class="o">)</span>
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> .&gt; task events: OFF <span class="o">(</span><span class="nb">enable</span> <span class="nt">-E</span> to monitor tasks <span class="k">in </span>this worker<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span>
 <span class="nt">--------------</span> <span class="o">[</span>queues]
                .&gt; celery           <span class="nv">exchange</span><span class="o">=</span>celery<span class="o">(</span>direct<span class="o">)</span> <span class="nv">key</span><span class="o">=</span>celery


<span class="o">[</span>tasks]
  <span class="nb">.</span> tasks.add

<span class="o">[</span>2022-01-17 23:32:33,390: INFO/MainProcess] Connected to redis://localhost:6379/0
<span class="o">[</span>2022-01-17 23:32:33,394: INFO/MainProcess] mingle: searching <span class="k">for </span>neighbors
<span class="o">[</span>2022-01-17 23:32:34,401: INFO/MainProcess] mingle: all alone
<span class="o">[</span>2022-01-17 23:32:34,440: INFO/MainProcess] celery@pop-os ready.
</code></pre></div></div>

<p>Хелпы: <code class="language-plaintext highlighter-rouge">celery worker --help</code> и <code class="language-plaintext highlighter-rouge">celery --help</code></p>

<p>Для вызова тасков можно использовать метод delay().</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<p>Теперь задача обработана воркером, назначенным ранее. Вы можете убедиться в этом в консоли. Вызов задачи возвращает экземпляр AsyncResult. Это можно использовать для проверки состояния задачи, ожидания завершения задачи или получения возвращаемого значения (или, если задача не удалась, для получения исключения и обратной трассировки). Результаты не включены по умолчанию. Чтобы выполнять удаленные вызовы процедур или отслеживать результаты задач в базе данных, вам необходимо настроить Celery для использования серверной части результатов.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2022-01-18 00:02:45,633: INFO/MainProcess]
Task tasks.add[9e31d371-cb34-4e76-b559-b2e92f612c7d] received
<span class="o">[</span>2022-01-18 00:02:45,634: INFO/ForkPoolWorker-8]
Task tasks.add[9e31d371-cb34-4e76-b559-b2e92f612c7d] succeeded <span class="k">in </span>0.00025742400612216443s: 8
</code></pre></div></div>

<p>Чтобы получить результат - его надо где-то хранить или куда-то отправить. На выбор куча бекендов под эти задачи, включая реляционыне базы данных и в т.ч. редис.</p>

<p>В <a href="https://docs.celeryproject.org/en/stable/getting-started/first-steps-with-celery.html#keeping-results">этом примере</a> используется rpc. Бекенд задается через аргумент при создании экземпляра воркера или через конфиг, например так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s">'redis://localhost'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'redis://localhost'</span><span class="p">)</span>
</code></pre></div></div>

<p>Теперь задача ставится в очередь, а результат отправляется на бекенд как только будет посчитан. Отправка осуществляется в асинхронном режиме. <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-result-backends">Подробнее про бекенды</a></p>

<p>Конфигурация celery - нужно сконфигурировать брокера и сконфигурировать бекенд. Про конфиги и дефолты <a href="https://docs.celeryproject.org/en/stable/userguide/configuration.html#configuration">читай тут</a>. Хорошей практикой является создание конфига <code class="language-plaintext highlighter-rouge">celeryconfig.py</code> и вызов конфигурации в app через <code class="language-plaintext highlighter-rouge">app.config_from_object('celeryconfig')</code></p>

<p>Пример конфига:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">broker_url</span> <span class="o">=</span> <span class="s">'pyamqp://'</span>
<span class="n">result_backend</span> <span class="o">=</span> <span class="s">'rpc://'</span>

<span class="n">task_serializer</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">result_serializer</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">accept_content</span> <span class="o">=</span> <span class="p">[</span><span class="s">'json'</span><span class="p">]</span>
<span class="n">timezone</span> <span class="o">=</span> <span class="s">'Europe/Oslo'</span>
<span class="n">enable_utc</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>Поддерживается формат в виде слвоаря. Отвалидировать конфиг можно так: <code class="language-plaintext highlighter-rouge">python -m celeryconfig</code>. Естественно можно создавать множество конфигов называя их как угодно для использования в разных приложениях celery</p>

<h2 id="более-подробный-пример"><a href="https://docs.celeryproject.org/en/stable/getting-started/next-steps.html">Более подробный пример</a></h2>

<ul>
  <li>Using Celery in your Application</li>
  <li>Calling Tasks</li>
  <li>Canvas: Designing Work-flows</li>
  <li>Routing</li>
  <li>Remote Control</li>
  <li>Timezone</li>
  <li>Optimization</li>
</ul>

<h3 id="создание-воркеров-и-тасков">Создание воркеров и тасков</h3>

<p>В примере разбирается проект с такой структурой:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proj/__init__.py
    /celery.py
    /tasks.py
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">celery.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'proj'</span><span class="p">,</span>
             <span class="n">broker</span><span class="o">=</span><span class="s">'amqp://'</span><span class="p">,</span>
             <span class="n">backend</span><span class="o">=</span><span class="s">'rpc://'</span><span class="p">,</span>
             <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s">'proj.tasks'</span><span class="p">])</span>

<span class="c1"># Optional configuration, see the application user guide.
</span><span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">result_expires</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>В данном случае в качестве брокера задан [<a href="rabbitmq" title="Rabbitmq">rabbitmq</a>], Бекендом является rpc, а в include мы прописываем путь к таскам - это необходимо, чтобы воркер знал где их искать после старта. Название воркера может не совпадать с названием содержащего фолдера.</p>

<p><code class="language-plaintext highlighter-rouge">tasks.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">xsum</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="два-режима-запуска">Два режима запуска</h3>

<p>Стуртуем воркера снаружи <code class="language-plaintext highlighter-rouge">proj</code> вот так: <code class="language-plaintext highlighter-rouge">celery -A proj worker -l INFO</code>. В данном режиме воркер запускается локально на одной ноде.</p>

<p>Аргумент <code class="language-plaintext highlighter-rouge">--app</code> (<code class="language-plaintext highlighter-rouge">-A</code>) указывает используемый экземпляр приложения Celery в виде <code class="language-plaintext highlighter-rouge">module.path:attribute</code>. Но он также поддерживает форму быстрого доступа. Если указано только имя пакета, он попытается найти экземпляр приложения в следующем порядке:</p>

<p>С <code class="language-plaintext highlighter-rouge">--app=proj</code> - атрибут с именем <code class="language-plaintext highlighter-rouge">proj.app</code>, или атрибут с именем <code class="language-plaintext highlighter-rouge">proj.celery</code>, или любой атрибут в модуль <code class="language-plaintext highlighter-rouge">proj</code>, где значением является приложение Celery, или если ничего из этого не найдено, он попытается использовать подмодуль с именем <code class="language-plaintext highlighter-rouge">proj.celery</code> и найти в нем атрибут с именем <code class="language-plaintext highlighter-rouge">proj.celery.app</code>, или атрибут с именем <code class="language-plaintext highlighter-rouge">proj.celery.celery</code>, или любой атрибут в модуле <code class="language-plaintext highlighter-rouge">proj.celery</code>, где значением является приложение Celery. Эта схема имитирует приемы, используемые в документации, то есть <code class="language-plaintext highlighter-rouge">proj:app</code> для одного автономного модуля и <code class="language-plaintext highlighter-rouge">proj.celery:app</code> для более крупных проектов.</p>

<p>Видим что-то типа этого:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">---------------</span> celery@halcyon.local v4.0 <span class="o">(</span>latentcall<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span>
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> <span class="o">[</span>Configuration]
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> <span class="nb">.</span> broker:      amqp://guest@localhost:5672//
- <span class="k">**</span> <span class="nt">----------</span> <span class="nb">.</span> app:         __main__:0x1012d8590
- <span class="k">**</span> <span class="nt">----------</span> <span class="nb">.</span> concurrency: 8 <span class="o">(</span>processes<span class="o">)</span>
- <span class="k">**</span> <span class="nt">----------</span> <span class="nb">.</span> events:      OFF <span class="o">(</span><span class="nb">enable</span> <span class="nt">-E</span> to monitor this worker<span class="o">)</span>
- <span class="k">**</span> <span class="nt">----------</span>
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> <span class="o">[</span>Queues]
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> <span class="nb">.</span> celery:      exchange:celery<span class="o">(</span>direct<span class="o">)</span> binding:celery
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span>

<span class="o">[</span>2012-06-08 16:23:51,078: WARNING/MainProcess] celery@halcyon.local has started.
</code></pre></div></div>

<p>Здесь <code class="language-plaintext highlighter-rouge">broker</code> - это юрл к нашему брокеру. <code class="language-plaintext highlighter-rouge">concurrency</code>  определяет сколько доступно ядер. <code class="language-plaintext highlighter-rouge">events</code> это параметр, который заставляет Celery отправлять сообщения мониторинга (события) для действий, происходящих в воркере. Они могут использоваться программами мониторинга, такими как [<a href="flower" title="Flower pip python">flower</a>]. <code class="language-plaintext highlighter-rouge">queues</code> это список доступных очередей, из которых процессы будут потреблять задачи. Это важный аспект, т.к. главный поинт в том, чтобы расписать из каких очередей что потреблять и в каком приоритете. Это делается через <a href="https://docs.celeryproject.org/en/stable/userguide/routing.html#guide-routing">маршрутизацию</a>.</p>

<p>В текущем режиме воркера можно остановить через <code class="language-plaintext highlighter-rouge">ctrl-c</code>. В реальных условиях воркеров потребуется запускать в фоне - <a href="https://docs.celeryproject.org/en/stable/userguide/daemonizing.html#daemonizing">читай руководство по “демонизации”</a>. Вкратце - celery использует общие init-скрипты для всех воркеров и они должны работать на всех юникс-подобных платформах. Начальным скриптом является <code class="language-plaintext highlighter-rouge">/etc/default/celeryd</code>. Для его запуска требуются привилегии суперюзера (от которого конечно ни при каких условиях запускаться нельзя ввиду небезопасности структур данных, используемых в celery). К счастью реализован запск через <code class="language-plaintext highlighter-rouge">celery multy</code>, которому рут-права не нужны. Выглядит это примерно так:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>celery multi start w1 <span class="nt">-A</span> proj <span class="nt">-l</span> INFO
celery multi v4.0.0 <span class="o">(</span>latentcall<span class="o">)</span>
<span class="o">&gt;</span> Starting nodes...
    <span class="o">&gt;</span> w1.halcyon.local: OK
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>celery  multi restart w1 <span class="nt">-A</span> proj <span class="nt">-l</span> INFO
celery multi v4.0.0 <span class="o">(</span>latentcall<span class="o">)</span>
<span class="o">&gt;</span> Stopping nodes...
    <span class="o">&gt;</span> w1.halcyon.local: TERM -&gt; 64024
<span class="o">&gt;</span> Waiting <span class="k">for </span>1 node.....
    <span class="o">&gt;</span> w1.halcyon.local: OK
<span class="o">&gt;</span> Restarting node w1.halcyon.local: OK
celery multi v4.0.0 <span class="o">(</span>latentcall<span class="o">)</span>
<span class="o">&gt;</span> Stopping nodes...
    <span class="o">&gt;</span> w1.halcyon.local: TERM -&gt; 64052
</code></pre></div></div>

<p>Запущенный в фоне воркер не помнит контекеста, поэтому все переданные ему аругменты командной строки необходимо передавать каждый раз при каждой кманде (wtf). Остановить можно через <code class="language-plaintext highlighter-rouge">multi stop</code>, но надо понить, что такая остановка будет синхронной, что может привести к незавершению ряда задач. Для асинхронного стпа использовать <code class="language-plaintext highlighter-rouge">stopwait</code></p>

<p>Вот так на самом деле придется запускать воркеров (создавая разделы для логов, чтобы не возникли ошибки <code class="language-plaintext highlighter-rouge">IOError: [Errno 13] Permission denied</code>):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">celery</span>
<span class="err">$</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">celery</span>
<span class="err">$</span> <span class="n">celery</span> <span class="n">multi</span> <span class="n">start</span> <span class="n">w1</span> <span class="o">-</span><span class="n">A</span> <span class="n">proj</span> <span class="o">-</span><span class="n">l</span> <span class="n">INFO</span> <span class="o">--</span><span class="n">pidfile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">celery</span><span class="o">/%</span><span class="n">n</span><span class="p">.</span><span class="n">pid</span> \
                                        <span class="o">--</span><span class="n">logfile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">celery</span><span class="o">/%</span><span class="n">n</span><span class="o">%</span><span class="n">I</span><span class="p">.</span><span class="n">log</span>
</code></pre></div></div>

<p>Кроме того. возможны ошибки с пермишеном к логам. Надо передать права. Смотри <a href="https://stackoverflow.com/questions/28825760/celery-not-running-permission-denied/28826090">тут</a> и <a href="https://stackoverflow.com/questions/22736808/celery-daemon-permission-denied-on-log-file">тут</a></p>

<h3 id="вызов-тасков">Вызов тасков</h3>

<p>Вызов тасков делается, как писалось выше, через <code class="language-plaintext highlighter-rouge">sig.delay(*args, **kwargs)</code>, котоырй является оберткой для <code class="language-plaintext highlighter-rouge">sig.apply_async(args=(), kwargs={}, **options)</code>, получающий больше конфигурационных аргументов (например название очереди или значение колдауна).</p>

<p>Если реализован бекенд, то результат можно получить через <code class="language-plaintext highlighter-rouge">get()</code>. Поддерживаются атрибуты, дающие доступ к состояниям:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">4</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="nb">id</span>
<span class="n">d6b3aea2</span><span class="o">-</span><span class="n">fb9b</span><span class="o">-</span><span class="mi">4</span><span class="n">ebc</span><span class="o">-</span><span class="mi">8</span><span class="n">da4</span><span class="o">-</span><span class="mi">848818</span><span class="n">db9114</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">failed</span><span class="p">()</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">successful</span><span class="p">()</span>
<span class="bp">True</span>
</code></pre></div></div>

<p>Если что-то пошло не так, будет поднята ошибка, избежать пропогейта которой можно так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">propagate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="nb">TypeError</span><span class="p">(</span><span class="s">"unsupported operand type(s) for +: 'int' and 'str'"</span><span class="p">)</span>
</code></pre></div></div>

<p>Такс проходит через три состояния (на самом деле состояние таска может меняться произволяно и SUCCESS не окончательный): PENDING -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; SUCCESS. Извлечь можно так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">state</span>
<span class="s">'FAILURE'</span>
</code></pre></div></div>

<p>Состояние STARTED появляется только если таск инициализирвоан через декоратор <code class="language-plaintext highlighter-rouge">@task(track_started=True)</code>, а PENDING просто определяет неопределенное состояние (дефолтное). <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-states">Про статусы подробно</a></p>

<h3 id="work-flow">Work-flow</h3>

<p>Для построения сложных конструкций в Celery предусмотрены сигнатуры (signature). Сигнатура упаковывает таск и аргументы полностью или частично для передачи всего этого как объекта дрвгим таскам или для сериализации.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">tasks</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>сокращенный вариант:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">delay</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
<span class="mi">4</span>
</code></pre></div></div>

<p>частичная передача аргументов:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># incomplete partial: add(?, 2)
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># resolves the partial: add(8, 2)
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">s2</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
<span class="mi">10</span>
</code></pre></div></div>

<h3 id="примитивы">Примитивы</h3>

<p>Все примитивы поддерживают частичные аргументы и могут быть скомбинированы между собой в любом порядке.</p>

<h4 id="groups">Groups</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">group</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span><span class="p">().</span><span class="n">get</span><span class="p">()</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="chains">Chains</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">mul</span>

<span class="c1"># (4 + 4) * 8
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))().</span><span class="n">get</span><span class="p">()</span>
<span class="mi">64</span>
</code></pre></div></div>

<p>Короткий вариант записи</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))().</span><span class="n">get</span><span class="p">()</span>
<span class="mi">64</span>
</code></pre></div></div>

<h4 id="chords">Chords</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chord</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">xsum</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">chord</span><span class="p">((</span><span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">xsum</span><span class="p">.</span><span class="n">s</span><span class="p">())().</span><span class="n">get</span><span class="p">()</span>
<span class="mi">90</span>
</code></pre></div></div>

<p>Если группа чейнится в другой таск, она автоматически конверстится в чорд:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span> <span class="n">xsum</span><span class="p">.</span><span class="n">s</span><span class="p">())().</span><span class="n">get</span><span class="p">()</span>
<span class="mi">90</span>
</code></pre></div></div>

<p>Больше конструкций и подробности <a href="https://docs.celeryproject.org/en/stable/userguide/canvas.html#guide-canvas">смотри тут</a></p>

<h3 id="routing">Routing</h3>

<p>Определять очереди можно как в конфигах, непосредственно в тасках или через cli:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">task_routes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'proj.tasks.add'</span><span class="p">:</span> <span class="p">{</span><span class="s">'queue'</span><span class="p">:</span> <span class="s">'hipri'</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div></div>

<p>или</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">proj.tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">queue</span><span class="o">=</span><span class="s">'hipri'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="remote-control"><a href="https://docs.celeryproject.org/en/stable/getting-started/next-steps.html#remote-control">Remote control</a></h3>

<p>Через <code class="language-plaintext highlighter-rouge">celery -A proj inspect</code> и <code class="language-plaintext highlighter-rouge">celery -A control</code>. К примеру все активные воркеры: <code class="language-plaintext highlighter-rouge">celery -A proj inspect active</code></p>

<h2 id="user-guide"><a href="https://docs.celeryproject.org/en/stable/userguide/index.html">user guide</a></h2>

<h3 id="application"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html">Application</a></h3>

<p>Вначале необходимо инициализировать экземпляр celery. Этот объект является потокобезопасным, так что несколько приложений Celery с разными конфигурациями, компонентами и задачами могут сосуществовать в одном и том же пространстве процессов.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span>
<span class="o">&lt;</span><span class="n">Celery</span> <span class="n">__main__</span><span class="p">:</span><span class="mh">0x100469fd0</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Здесь имеется название, название модуля и адрес в памяти, но значение имеет только имя модуля, т.к. селери общается с помощью меседжей, которые не содержат кода, а содержат только имена тасков, которые необходимо вызвать. Задачи добавояются в локальный регистр задач:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="p">...</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span>
<span class="o">&lt;@</span><span class="n">task</span><span class="p">:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">add</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="n">__main__</span><span class="p">.</span><span class="n">add</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">tasks</span><span class="p">[</span><span class="s">'__main__.add'</span><span class="p">]</span>
<span class="o">&lt;@</span><span class="n">task</span><span class="p">:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">add</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Когда celery не может определить к какому модуля принадлэеит функция, он использует <code class="language-plaintext highlighter-rouge">__main__</code>. Эта ситуация возникает при вызове модуля, в котором определена задача, как программы или через терминал python. Но при импорте это будет выглядеть иначе:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="n">tasks</span><span class="p">.</span><span class="n">add</span>
</code></pre></div></div>

<p>В конечном итоге имя основного модуля можно указать непосредственно, тогда в вызове из <code class="language-plaintext highlighter-rouge">__main__</code> все будет ок</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">main</span>
<span class="s">'tasks'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="p">...</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="n">tasks</span><span class="p">.</span><span class="n">add</span>
</code></pre></div></div>

<h4 id="configuration-приложения"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html#configuration">Configuration</a> приложения</h4>

<p>Конфиг доступен через атрибут <code class="language-plaintext highlighter-rouge">app.conf</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">timezone</span>
<span class="s">'Europe/London'</span>
</code></pre></div></div>

<p>можно задать значения напрямую</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">enable_utc</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>или через апдейт сразу нескольких атрибутов</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">update</span><span class="p">(</span>
<span class="p">...</span>     <span class="n">enable_utc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">...</span>     <span class="n">timezone</span><span class="o">=</span><span class="s">'Europe/London'</span><span class="p">,</span>
<span class="p">...</span> <span class="p">)</span>
</code></pre></div></div>

<p>Другие способы (к примеру из ф-ла, переменных окружения или из конфигурационного класса) смотри <a href="https://docs.celeryproject.org/en/stable/userguide/application.html#config-from-object">в доке</a>.</p>

<p>Запретить вывод в отладку определененых конфигов <a href="https://docs.celeryproject.org/en/stable/userguide/application.html#censored-configuration">можно так</a>.</p>

<p><a href="https://docs.celeryproject.org/en/stable/userguide/configuration.html#configuration">Список доступных конфигов</a></p>

<h4 id="laziness"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html#laziness">Laziness</a></h4>

<p>Экземпляр приложения является ленивым (laziness), то есть он не будет извлекаться до тех пор, пока он действительно не понадобится.</p>

<p><code class="language-plaintext highlighter-rouge">app.task()</code> декораторы не создают задачи в тот момент, когда задача определена, вместо этого они откладывают создание задачи до того момента, как она будет использована, или после того, как приложение celery будет финализировано/</p>

<p>Финализация приложения происходит или явно путем вызова <code class="language-plaintext highlighter-rouge">app.finalize()</code> или неявно, путем доступа атрибуту таска приложения. При финализации задачи, которые должны быть разделены между приложениями, корпиуются, оцениваются все декораторы задач, происходит сверка принадлежности задач приложению.</p>

<h4 id="breaking-the-chain"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html#breaking-the-chain">Breaking the chain</a></h4>

<p>Здесь объясняется как правильно передавать экземпляры приложений другим объектам.</p>

<h4 id="абстрактные-задачи"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html#abstract-tasks">Абстрактные задачи</a></h4>

<p>Объясняется как создавать задачи из других базовых классов кроме <code class="language-plaintext highlighter-rouge">Task</code></p>

<h3 id="tasks"><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html">Tasks</a></h3>

<p>Задача - это класс, который можно сконструировать из любого вызываемого объекта. Он выполняет двойную роль: определяет что происходит при вызове задачи (отправляет сообщение), и что происходит, когда воркер получает это сообщение.</p>

<p>Каждый класс задач имеет уникальное имя, и на это имя ссылаются в сообщениях, чтобы воркер мог найти нужную функцию для выполнения.</p>

<p>Сообщение таска не удаляется из очереди, пока это сообщение не будет подтверждено воркером. Воркер может заранее зарезервировать множество сообщений, и даже если он прекратит существовать - из-за сбоя питания или по какой-либо другой причине - сообщение будет повторно доставлено другому воркеру.</p>

<p>В идеале функции тасков должны быть идемпотентными: это означает, что <strong>функция не будет вызывать непредвиденных эффектов, даже если вызывается несколько раз с одними и теми же аргументами</strong>. Поскольку рабочий процесс не может определить, являются ли ваши таски идемпотентными, поведение по умолчанию заключается в том, чтобы заранее подтвердить сообщение, непосредственно перед его выполнением. Тогда вызов таска, который уже был запущен, никогда не выполнялся снова.</p>

<p>Если ваша задача идемпотентна, вы можете установить опцию <code class="language-plaintext highlighter-rouge">acks_late</code>, чтобы вместо этого воркер подтвердил сообщение после того, как задача вернется.</p>

<p>Воркер подтвердит сообщение, если дочерний процесс, выполняющий задачу, будет завершен (либо задачей, вызывающей <code class="language-plaintext highlighter-rouge">sys.exit()</code>, либо сигналом), даже если <code class="language-plaintext highlighter-rouge">acks_late</code> включен. Такое поведение выполнено преднамеренно, поскольку:</p>

<ul>
  <li>мы не хотим повторно запускать таски, которые заставляют ядро отправлять SIGSEGV (ошибка сегментации) или аналогичные сигналы процессу</li>
  <li>мы предполагаем, что системный администратор, намеренно завершающий задачу, не хочет ее автоматического перезапуска</li>
  <li>таск, который выделяет слишком много памяти, рискует скрашить ядро, то же самое может произойти снова</li>
  <li>таск, который всегда завершается ошибкой при повторной доставке, может вызвать высокочастотный цикл передачи сообщений, приводящий к остановке системы.</li>
</ul>

<p>Если вы действительно хотите, чтобы задача была повторно доставлена в этих сценариях, вам следует рассмотреть возможность включения параметра <code class="language-plaintext highlighter-rouge">task_reject_on_worker_lost</code>.</p>

<p>Если для текущего таска не нужны результаты, их можно отключить через декоратор <code class="language-plaintext highlighter-rouge">@task(ignore_result=True)</code></p>

<h4 id="базовое-использование"><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#basics">Базовое использование</a></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s">'json'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</code></pre></div></div>

<p>В данном случае при создании таска использовалась опция serializer - смотри <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-options">список опций для тасков</a>.</p>

<p><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#bound-tasks">Bound task</a> - это такие таски, в которых первый аргумент это всегда инстанс таска (self), так же как в методах python. Связанные задачи необходимы для повторных попыток (с помощью <code class="language-plaintext highlighter-rouge">app.Task.retry()</code>), для доступа к информации о текущем запросе задачи и для любых дополнительных функций, которые вы добавляете в базовые классы пользовательских задач.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div></div>

<p>Возможно наследование таска от базового класса при помощи аргумента декоратора <code class="language-plaintext highlighter-rouge">base</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">celery</span>

<span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">celery</span><span class="p">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">einfo</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'{0!r} failed: {1!r}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">raise</span> <span class="nb">KeyError</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="name">Name</h4>

<p>У каждого таска должно быть уникальное имя. Если имя не задано - оно будет сгенерировано из имени модуля и имени функции</p>

<p>Лучшая практика - использовать имя модуля как неймспейс для имени таска, чтобы избежат ьконфликта имен. В данном случае задано такое же имя, какое могло бы быть сгенерировано автоматически для таска, заданного в модуле <code class="language-plaintext highlighter-rouge">tasks.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'tasks.add'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="s">'tasks.add'</span>
</code></pre></div></div>

<p>Вопрос автонейминга и релятивного импорта описан <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#automatic-naming-and-relative-imports">тут</a>. Как менять схему автонейминга описано <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#changing-the-automatic-naming-behavior">тут</a>.</p>

<h4 id="task-request">Task request</h4>

<p><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-request">Запрос задачи</a> осуществляется через <code class="language-plaintext highlighter-rouge">app.Task.request</code>, который содержит информацию и состояние текущего таска. Подробнее об атрибутах запрсоа смотри <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-request">в доке</a>. Пример:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s">'Executing task id {0.id}, args: {0.args!r} kwargs: {0.kwargs!r}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></div>

<h4 id="logging">Logging</h4>

<p>Воркер может автоматически логировать данные. Это можно настроить вручную. <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#logging">Подробнее</a>. Лучшая практика - создать простой логгер для всех тасков в модуле:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_task_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Adding {0} + {1}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div></div>

<p>Селери использует стандартную питоню библиотеку для логирования. [<a href="../lists/python-logging" title="Python logging">python-logging</a>]</p>

<h4 id="args-check">Args check</h4>

<p>Реализована стандартная для python проверка аргументво таска, которую <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#argument-checking">можно отключить</a>. Кроме того, конфиденциальную информацию аргументво <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#hiding-sensitive-information-in-arguments">можно скрывать</a>.</p>

<h4 id="retrying">Retrying</h4>

<p><code class="language-plaintext highlighter-rouge">app.Task.retry()</code> используется для повтороного извлечения таска, например в случае ошибки. В этом случае будет оправлено новое сообщение с тем же идентификатором, чтобы сообщение было поставлено в туже очередь, что и исходная задача. <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#retrying">Подробнее</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="p">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="p">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="p">.</span><span class="n">LoginError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="p">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div></div>

<p>Что еще доступно:</p>

<ul>
  <li><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#using-a-custom-retry-delay">пользовательская задержка повтора</a></li>
  <li><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#automatic-retry-for-known-exceptions">автоматический повтор</a> для известных исключений</li>
</ul>

<p>Подробнее читай <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#retrying">в доке</a>.</p>

<h4 id="состояния">Состояния</h4>

<p>Celery может <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#states">хранить состояние текущего таска</a> - это результат задачи или поднятая ошибка. Реализовано несколько бекендов для резалтов, <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-result-backends">Смотри чем они отличаются тут</a>. Про <a href="https://docs.celeryproject.org/en/stable/userguide/configuration.html#conf-result-backend">настройку бекендов</a>. Про <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#result-backends">бекенды в целом</a>.</p>

<p>За время своего существования задача будет проходить через несколько возможных состояний, и к каждому состоянию могут быть присоединены произвольные метаданные. Когда задача переходит в новое состояние, о предыдущем состоянии будет забыть, но некоторые переходы можно вывести (например, FAILED подразумевается, что задача, находящаяся сейчас в состоянии, находилась в STARTED состоянии в какой-то момент).</p>

<p>Существуют также наборы состояний, такие как набор FAILURE_STATES и набор READY_STATES.</p>

<p>Клиент использует членство в этих наборах, чтобы решить, следует ли повторно инициировать исключение (PROPAGATE_STATES) или можно ли кэшировать состояние.</p>

<p>Кроме торго, можно определить <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#custom-states">пользовательские состояния</a>. Встреонные статусы <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#built-in-states">описаны тут</a></p>

<h4 id="полупредикаты">Полупредикаты</h4>

<p>Можно поднять несколько экцепшенов, которые <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#semipredicates">обеспечат определенное поведение воркера</a> для записи финального состояния. Это позволяет игнорить или отклонять таски. Реализовано:</p>

<ul>
  <li>Ignore</li>
  <li>Reject</li>
  <li>Retry</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="n">Ignore</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">some_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">redis</span><span class="p">.</span><span class="n">ismember</span><span class="p">(</span><span class="s">'tasks.revoked'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</code></pre></div></div>

<p>Кроме того, можно задавать <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#custom-task-classes">кастомные классы</a> для тасков, отнаследовавшись от базового <code class="language-plaintext highlighter-rouge">Task</code></p>

<p>Можно <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#ignore-results-you-don-t-want">игнорить резалт таска</a>, если он неважен. Есть и другие способы <a href="https://docs.celeryproject.org/en/stable/userguide/optimizing.html#guide-optimizing">оптимизировать производительность</a>.</p>

<p>Если нужно организовать таски последовательно, это может привести к непредвиденным задержкам в выполнении цепочки. Лучше организовать цепочку <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#avoid-launching-synchronous-subtasks">асинхронно</a>.</p>

<p>Пример (плохо)</p>

<pre><code class="language-pythpn">@app.task
def update_page_info(url):
    page = fetch_page.delay(url).get()
    info = parse_page.delay(url, page).get()
    store_page_info.delay(url, info)

@app.task
def fetch_page(url):
    return myhttplib.get(url)

@app.task
def parse_page(page):
    return myparser.parse_document(page)

@app.task
def store_page_info(url, info):
    return PageInfo.objects.create(url, info)
</code></pre>

<p>С использованием сейна тасков (хорошо):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c1"># fetch_page -&gt; parse_page -&gt; store_page
</span>    <span class="n">chain</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">|</span> <span class="n">parse_page</span><span class="p">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">store_page_info</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">chain</span><span class="p">()</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="p">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="стратегии-повышения-производительности"><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#performance-and-strategies">Стратегии повышения производительности</a></h4>

<h4 id="пример-использования-тасков-для-фильтрации-спама-на-джанго-тут"><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-example">Пример использования тасков для фильтрации спама на джанго тут</a></h4>

<h3 id="как-вызывать-таски"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html">Как вызывать таски</a></h3>

<h4 id="базавые-принципы">Базавые принципы</h4>

<p><code class="language-plaintext highlighter-rouge">T.delay(arg, kwarg=value)</code>
Star arguments shortcut to .apply_async. (.delay(*args, **kwargs) calls .apply_async(args, kwargs)).</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async((arg,), {'kwarg': value})</code></p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(countdown=10)</code>
выполняется через 10 секунд</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(eta=now + timedelta(seconds=10))</code>
выполняется через 10 секунд, указанный с помощью eta</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(countdown=60, expires=120)</code>
выполняется через одну минуту, но истекает через 2 минуты</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(expires=now + timedelta(days=2))</code>
истекает через 2 дня, устанавливается с помощью datetime.</p>

<p>В большинстве случаев используется <code class="language-plaintext highlighter-rouge">delay()</code>, но если нужны дополнительные опции, то <code class="language-plaintext highlighter-rouge">apply_async</code>. Еще один способ - вызвать через signature, вот так: <code class="language-plaintext highlighter-rouge">task.s(arg1, arg2, kwarg1='x', kwargs2='y').apply_async()</code>. Читай про <a href="https://docs.celeryproject.org/en/stable/userguide/canvas.html">построение воркфлоу через signature</a></p>

<p>Все примеры ниже для этой функции</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div></div>

<h4 id="linking-callbackserrbacks">Linking (callbacks/errbacks)</h4>

<p>Поддерживаются <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#linking-callbacks-errbacks">слинкованные таски</a>, так что одна задача следует за другой. Задача обратного вызова будет применяться с результатом родительской задачи в качестве частичного аргумента:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">add</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</code></pre></div></div>

<p>Если таск поднимает исключение, можно вызвать <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#linking-callbacks-errbacks">колбек напрямую</a></p>

<p>Кроме того, Celery поддерживает перехват всех изменений состояния, <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#on-message">устанавливая обратный вызов on_message</a>.</p>

<h4 id="eta-and-countdown"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#eta-and-countdown">ETA and Countdown</a></h4>

<p>Поддерживается <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#eta-and-countdown">установка</a> времени срабатывания и ожидаемого времени выполнения</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="p">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>    <span class="c1"># не раньше чем через 3 секунды
</span><span class="mi">20</span>
</code></pre></div></div>

<p>ETA (расчетное время прибытия) позволяет установить конкретную дату и время, которые являются самым ранним временем выполнения задачи. Eta должен быть datetime объектом, указывающим точную дату и время (включая точность в миллисекундах и информацию о часовом поясе)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">tomorrow</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="expiration">Expiration</h4>

<p>Аргумент expires определяет необязательное время истечения срока действия, либо в секундах после публикации задачи, либо в определенную дату и время, используя datetime. Когда рабочий процесс получает задачу с истекшим сроком действия, он помечает задачу как REVOKED(TaskRevokedError).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="c1"># Task expires after one minute from now.
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">expires</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># Also supports datetime
</span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">kwargs</span><span class="p">,</span>
<span class="p">...</span>                 <span class="n">expires</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="повторная-отправка">Повторная отправка</h4>

<p>Celery будет автоматически повторять отправку сообщений в случае сбоя подключения, а поведение повторных попыток <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#message-sending-retry">можно настроить</a></p>

<h4 id="обработка-ошибок-соединения-с-транспортом"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#connection-error-handling">Обработка ошибок соединения с транспортом</a></h4>

<h4 id="serializers"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#serializers">Serializers</a></h4>

<p>Данные, передаваемые между клиентами и работниками, должны быть сериализованы, поэтому каждое сообщение в Celery имеет content_type заголовок, описывающий метод сериализации, используемый для его кодирования.</p>

<h4 id="compression"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#compression">Compression</a></h4>

<h4 id="connections"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#connections">Connections</a></h4>

<p>Соединения можно обрабатывать вручную, создавая паблишеров.</p>

<p>Смотри еще <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#routing-options">перенаправление задач в разные очереди</a> и как <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#results-options">отклонять результаты задач</a>.</p>

<h3 id="canvas-designing-work-flows"><a href="https://docs.celeryproject.org/en/stable/userguide/canvas.html">Canvas: Designing Work-flows</a></h3>

<p>В разделе перечисляются примитивы и конструкции для signatures и как собирать асинхронные цепочки выполнения тасков.</p>

<h3 id="workers"><a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#workers-guide">Workers</a></h3>

<p>Самый простой способ запустить воркера - <code class="language-plaintext highlighter-rouge">celery -A proj worker -l INFO</code></p>

<p>Можно запускать множество воркеров, при этом обязательно указание имени узла</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>celery <span class="nt">-A</span> proj worker <span class="nt">--loglevel</span><span class="o">=</span>INFO <span class="nt">--concurrency</span><span class="o">=</span>10 <span class="nt">-n</span> worker1@%h
<span class="nv">$ </span>celery <span class="nt">-A</span> proj worker <span class="nt">--loglevel</span><span class="o">=</span>INFO <span class="nt">--concurrency</span><span class="o">=</span>10 <span class="nt">-n</span> worker2@%h
<span class="nv">$ </span>celery <span class="nt">-A</span> proj worker <span class="nt">--loglevel</span><span class="o">=</span>INFO <span class="nt">--concurrency</span><span class="o">=</span>10 <span class="nt">-n</span> worker3@%h
</code></pre></div></div>

<p>Воркера можно <a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#stopping-the-worker">завершить</a> или <a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#restarting-the-worker">рестартнуть</a>. Все остальное (совместная работа, управление и т.д.) смотри в <a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#workers-guide">документации</a></p>

<h3 id="запуск-демонов"><a href="https://docs.celeryproject.org/en/stable/userguide/daemonizing.html">Запуск демонов</a></h3>

<h3 id="периодически-запускаемые-таски"><a href="https://docs.celeryproject.org/en/stable/userguide/periodic-tasks.html">Периодически запускаемые таски</a></h3>

<p>В разделе рассматривается работа celery beat - планировщика, запускающего таски через равные промежутки времени.</p>

<h3 id="routing-tasks"><a href="https://docs.celeryproject.org/en/stable/userguide/routing.html">Routing Tasks</a></h3>

<p>Рассматривается автоматическое и ручное распределение по очередям и некотоыре опции.</p>

<h3 id="monitoring-and-management-guide"><a href="https://docs.celeryproject.org/en/stable/userguide/monitoring.html">Monitoring and Management Guide</a></h3>

<p>В том числе про [<a href="flower" title="Flower pip python">flower</a>]</p>

<h3 id="security"><a href="https://docs.celeryproject.org/en/stable/userguide/security.html">Security</a></h3>

<h3 id="optimizing"><a href="https://docs.celeryproject.org/en/stable/userguide/optimizing.html">Optimizing</a></h3>

<h3 id="debugging"><a href="https://docs.celeryproject.org/en/stable/userguide/debugging.html">Debugging</a></h3>

<h3 id="concurrency"><a href="https://docs.celeryproject.org/en/stable/userguide/concurrency/index.html">Concurrency</a></h3>

<h3 id="signals"><a href="https://docs.celeryproject.org/en/stable/userguide/signals.html">Signals</a></h3>

<h3 id="testing-with-celery"><a href="https://docs.celeryproject.org/en/stable/userguide/testing.html">Testing with Celery</a></h3>

<h3 id="extensions-and-bootsteps"><a href="https://docs.celeryproject.org/en/stable/userguide/extending.html">Extensions and Bootsteps</a></h3>

<h3 id="configuration-and-defaults"><a href="https://docs.celeryproject.org/en/stable/userguide/configuration.html">Configuration and defaults</a></h3>

<p>Смотри еще:</p>

<ul>
  <li><a href="https://docs.celeryproject.org/en/stable/reference/cli.html?highlight=command">документация cli celery</a></li>
  <li>[<a href="redis" title="Redis">redis</a>]</li>
  <li>[<a href="rabbitmq" title="Rabbitmq">rabbitmq</a>]</li>
  <li>[<a href="flower" title="Flower pip python">flower</a>]</li>
  <li>[<a href="asyncio" title="Asyncio">asyncio</a>]</li>
  <li>[<a href="fastapi" title="Fastapi">fastapi</a>]</li>
</ul>

<p>Более простой аналог: [<a href="python-rq" title="Python-rq">python-rq</a>]</p>


  </div>
</article>


    </main>

    <footer role="banner">
<div class="border-top-thin clearfix mt-2 mt-lg-4">
    <div class="container mx-auto px-2">
      <p class="col-8 sm-width-full left py-2 mb-0"><a href="/myknowlegebase/">My knowledge base</a> проект поддерживается <a class="text-accent" href="https://github.com/KonstantinKlepikov">KonstantinKlepikov</a></p>
      <ul class="list-reset right clearfix sm-width-full py-2 mb-2 mb-lg-0">
        <li class="inline-block mr-1">
          <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="My knowledge base">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        </li>
      </ul>
    </div>
  </div>
</footer>

  </body>

</html>

<script type="text/javascript">
  // Hack: Replace page-link with "Page Title"
  document.querySelectorAll(".markdown-body a[title]").forEach((a) => {
    a.innerText = a.title;
  });
  // Hack: Remove .md extension from wikilinks to get the html in jekyll
  document.querySelectorAll("a").forEach(l => {
    if (l.href.endsWith('.md')) {
      l.href = l.href.substring(0, l.href.length-3)
    }
  })
</script>