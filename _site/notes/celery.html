<!DOCTYPE html>
<html lang="ru-RU">

<html>

  <head>

    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Celery | My knowlege base</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Celery" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Очередь задач в python с помощью celery" />
<meta property="og:description" content="Очередь задач в python с помощью celery" />
<link rel="canonical" href="https://konstantinklepikov.github.io/myknowlegebase/notes/celery.html" />
<meta property="og:url" content="https://konstantinklepikov.github.io/myknowlegebase/notes/celery.html" />
<meta property="og:site_name" content="My knowlege base" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://konstantinklepikov.github.io/myknowlegebase/notes/celery.html","headline":"Celery","description":"Очередь задач в python с помощью celery","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style"
        type="text/css" crossorigin>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    
    
    <link rel="stylesheet" href="https://konstantinklepikov.github.io/myknowlegebase/assets/css/style.css">

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->


  <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(53548570, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/53548570" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139620627-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-139620627-1');
  </script>


<!-- Favicon -->
<link rel="icon" href="/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">

<!-- Math support -->
<!-- Mathjax Support -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->

</head>

  <body>

    <header role="banner">
    <div class="container">
        <h1 id="a-title"><a href="/myknowlegebase/">My knowlege base</a></h1>
        <h2 class="project-tagline">Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения</h2>
        <p>Тут собраны заметки по программированию, машинному обучению и алгоритмам, которые автор <a href=""></a> делал и продолжает делать в процессе обучения. Тысяча извинений за сумбурность записей, орфографию и изрядную долю копипасты. По сути это конспект. Более толковые статьи можно почитать в блоге <a href="https://konstantinklepikov.github.io/">my deep learning</a></p>
    </div>
</header>

    <main id="main-content" class="container" role="main">

      <h1 id="celery">Celery</h1>

<h2 id="intro">Intro</h2>

<p><a href="https://docs.celeryproject.org/en/stable/">Celery</a> is a simple, flexible, and reliable distributed system to process vast amounts of messages, while providing operations with the tools required to maintain such a system.</p>

<p>Очереди используются как механизм для распределения работы по потокам или процессам.</p>

<p>Celery использует брокера для посредничества между клиентами и воркерами. Чтобы инициировать задачу, клиент добавляет сообщение в очередь, а затем брокер доставляет это сообщение воркеру.</p>

<p>Система Celery может состоять из нескольких воркеров и брокеров. Celery написан на python, но протокол может быть реализован на любом языке.</p>

<p>Простейший пример приложения.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'hello'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'amqp://guest@localhost//'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'hello world'</span>
</code></pre></div></div>

<p>Celery поддерживает:</p>

<ul>
  <li>brokers [<a href="redis" title="Redis">redis</a>], [<a href="rabbitmq" title="Rabbitmq">rabbitmq</a>], amazonsqs и <a href="https://docs.celeryproject.org/en/stable/getting-started/backends-and-brokers/index.html#brokers">т.д.</a></li>
  <li>совместная работа обеспечивается через multiprocessing, eventied, gevent, multithreading или solo threading реализации</li>
  <li>поддерживает хранилища: AMQP, Redis, Memcached, SQLAlchemy, Django ORM, Apache Cassandra, Elasticsearch, Riak, MongoDB, CouchDB, Couchbase, ArangoDB, Amazon DynamoDB, Amazon S3, Microsoft Azure Block Blob, Microsoft Azure Cosmos DB, file system</li>
  <li>сериализация: pickle, json, yaml, msgpack, zlib, bzip2, Cryptographic message signing.</li>
</ul>

<p>Фичи:</p>

<ul>
  <li>мониторинг событий</li>
  <li>планировщик задач</li>
  <li>планировщик рабочих процессов</li>
  <li>защита от утечки ресурсов</li>
  <li>установка лимитов по времени и скорости</li>
  <li>кастомизируемость</li>
</ul>

<p>Как инсталить <a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html#installation">смотри тут</a>. Там же весь набор бандлов для установки бекендов, сериализации, транспорта и т.д.</p>

<p><a href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html#celery-is">introduction</a></p>

<h2 id="быстрый-запуск"><a href="https://docs.celeryproject.org/en/stable/getting-started/first-steps-with-celery.html#redis">Быстрый запуск</a></h2>

<ul>
  <li>Выбираем и ставим транспорт сообщений (брокер)</li>
  <li>ставим Celery и создаем первую задачу</li>
  <li>запуск воркера и вызываем задачу</li>
  <li>отслеживаем задачи по мере их перехода через разные состояния и првоеряем возвращаемые значения</li>
</ul>

<p>Брокеры: [<a href="rabbitmq" title="Rabbitmq">rabbitmq</a>] или [<a href="redis" title="Redis">redis</a>]</p>

<p>Для редиса можно черех [<a href="../lists/docker" title="Docker">docker</a>]: <code class="language-plaintext highlighter-rouge">docker run -d -p 6379:6379 redis</code></p>

<p>Ставим celery: <code class="language-plaintext highlighter-rouge">pip install celery</code></p>

<p><a href="https://docs.celeryproject.org/en/stable/getting-started/backends-and-brokers/redis.html#broker-redis">Ставим коннектор</a> для [<a href="redis" title="Redis">redis</a>]: <code class="language-plaintext highlighter-rouge">pip install -U "celery[redis]"</code></p>

<p>Пишем апку (в боевых условия нам конечно понадобится сконфигурировать <a href="https://docs.celeryproject.org/en/stable/getting-started/backends-and-brokers/redis.html#broker-redis">доступ к redis</a>, задав и указав логин/пароль)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'redis://localhost:6379/0'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div></div>

<p>Первым аргументом Celery является имя текущего модуля. Это нужно только для того, чтобы имена могли генерироваться автоматически, когда задачи определены в модуле <code class="language-plaintext highlighter-rouge">__main__</code>. Второй аргумент — это аргумент ключа брокера, указывающий URL-адрес брокера сообщений, который вы хотите использовать.</p>

<ul>
  <li>для rabbitmq <code class="language-plaintext highlighter-rouge">amqp://localhost</code></li>
  <li>для redis <code class="language-plaintext highlighter-rouge">redis://localhost</code></li>
</ul>

<p>Стартуема сервер из папки приложения: <code class="language-plaintext highlighter-rouge">celery -A tasks worker --loglevel=INFO</code> В данном случае сервак запускается в лоб. В реальности нужен демон - <a href="https://docs.celeryproject.org/en/stable/userguide/daemonizing.html#daemonizing">смотри тут</a></p>

<p>Тада:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">--------------</span> celery@pop-os v5.2.3 <span class="o">(</span>dawn-chorus<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span> 
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> Linux-5.8.0-7630-generic-x86_64-with-glibc2.32 2022-01-17 23:32:33
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> 
- <span class="k">**</span> <span class="nt">----------</span> <span class="o">[</span>config]
- <span class="k">**</span> <span class="nt">----------</span> .&gt; app:         tasks:0x7fdfe7e14a60
- <span class="k">**</span> <span class="nt">----------</span> .&gt; transport:   redis://localhost:6379/0
- <span class="k">**</span> <span class="nt">----------</span> .&gt; results:     disabled://
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> .&gt; concurrency: 12 <span class="o">(</span>prefork<span class="o">)</span>
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> .&gt; task events: OFF <span class="o">(</span><span class="nb">enable</span> <span class="nt">-E</span> to monitor tasks <span class="k">in </span>this worker<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span> 
 <span class="nt">--------------</span> <span class="o">[</span>queues]
                .&gt; celery           <span class="nv">exchange</span><span class="o">=</span>celery<span class="o">(</span>direct<span class="o">)</span> <span class="nv">key</span><span class="o">=</span>celery
                

<span class="o">[</span>tasks]
  <span class="nb">.</span> tasks.add

<span class="o">[</span>2022-01-17 23:32:33,390: INFO/MainProcess] Connected to redis://localhost:6379/0
<span class="o">[</span>2022-01-17 23:32:33,394: INFO/MainProcess] mingle: searching <span class="k">for </span>neighbors
<span class="o">[</span>2022-01-17 23:32:34,401: INFO/MainProcess] mingle: all alone
<span class="o">[</span>2022-01-17 23:32:34,440: INFO/MainProcess] celery@pop-os ready.
</code></pre></div></div>

<p>Хелпы: <code class="language-plaintext highlighter-rouge">celery worker --help</code> и <code class="language-plaintext highlighter-rouge">celery --help</code></p>

<p>Для вызова тасков можно использовать метод delay().</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<p>Теперь задача обработана воркером, назначенным ранее. Вы можете убедиться в этом в консоли. Вызов задачи возвращает экземпляр AsyncResult. Это можно использовать для проверки состояния задачи, ожидания завершения задачи или получения возвращаемого значения (или, если задача не удалась, для получения исключения и обратной трассировки). Результаты не включены по умолчанию. Чтобы выполнять удаленные вызовы процедур или отслеживать результаты задач в базе данных, вам необходимо настроить Celery для использования серверной части результатов.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2022-01-18 00:02:45,633: INFO/MainProcess] 
Task tasks.add[9e31d371-cb34-4e76-b559-b2e92f612c7d] received
<span class="o">[</span>2022-01-18 00:02:45,634: INFO/ForkPoolWorker-8] 
Task tasks.add[9e31d371-cb34-4e76-b559-b2e92f612c7d] succeeded <span class="k">in </span>0.00025742400612216443s: 8
</code></pre></div></div>

<p>Чтобы получить результат - его надо где-то хранить или куда-то отправить. На выбор куча бекендов под эти задачи, включая реляционыне базы данных и в т.ч. редис.</p>

<p>В <a href="https://docs.celeryproject.org/en/stable/getting-started/first-steps-with-celery.html#keeping-results">этом примере</a> используется rpc. Бекенд задается через аргумент при создании экземпляра воркера или через конфиг, например так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s">'redis://localhost'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'redis://localhost'</span><span class="p">)</span>
</code></pre></div></div>

<p>Теперь задача ставится в очередь, а результат отправляется на бекенд как только будет посчитан. Отправка осуществляется в асинхронном режиме. <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-result-backends">Подробнее про бекенды</a></p>

<p>Конфигурация celery - нужно сконфигурировать брокера и сконфигурировать бекенд. Про конфиги и дефолты <a href="https://docs.celeryproject.org/en/stable/userguide/configuration.html#configuration">читай тут</a>. Хорошей практикой является создание конфига <code class="language-plaintext highlighter-rouge">celeryconfig.py</code> и вызов конфигурации в app через <code class="language-plaintext highlighter-rouge">app.config_from_object('celeryconfig')</code></p>

<p>Пример конфига:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">broker_url</span> <span class="o">=</span> <span class="s">'pyamqp://'</span>
<span class="n">result_backend</span> <span class="o">=</span> <span class="s">'rpc://'</span>

<span class="n">task_serializer</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">result_serializer</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">accept_content</span> <span class="o">=</span> <span class="p">[</span><span class="s">'json'</span><span class="p">]</span>
<span class="n">timezone</span> <span class="o">=</span> <span class="s">'Europe/Oslo'</span>
<span class="n">enable_utc</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>Поддерживается формат в виде слвоаря. Отвалидировать конфиг можно так: <code class="language-plaintext highlighter-rouge">python -m celeryconfig</code>. Естественно можно создавать множество конфигов называя их как угодно для использования в разных приложениях celery</p>

<p>Более подробный пример <a href="https://docs.celeryproject.org/en/stable/getting-started/next-steps.html">реализован тут</a> и включает:</p>

<ul>
  <li>Using Celery in your Application</li>
  <li>Calling Tasks</li>
  <li>Canvas: Designing Work-flows</li>
  <li>Routing</li>
  <li>Remote Control</li>
  <li>Timezone</li>
  <li>Optimization</li>
</ul>

<h2 id="user-guide"><a href="https://docs.celeryproject.org/en/stable/userguide/index.html">user guide</a></h2>

<h3 id="application"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html">Application</a></h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span>
<span class="o">&lt;</span><span class="n">Celery</span> <span class="n">__main__</span><span class="p">:</span><span class="mh">0x100469fd0</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Значение имеет main имя модуля, т.к. селери общается с помощью меседжей. Извлекается имя таска для того чтобы каждый воркер знал к какой функции ему образщаться.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="p">...</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span>
<span class="o">&lt;@</span><span class="n">task</span><span class="p">:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">add</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="n">__main__</span><span class="p">.</span><span class="n">add</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">tasks</span><span class="p">[</span><span class="s">'__main__.add'</span><span class="p">]</span>
<span class="o">&lt;@</span><span class="n">task</span><span class="p">:</span> <span class="n">__main__</span><span class="p">.</span><span class="n">add</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Мы можем извлечь имя в main к примеру для tasks.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">worker_main</span><span class="p">()</span>
</code></pre></div></div>

<p>Но при импорте это будет выглядеть иначе:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="n">tasks</span><span class="p">.</span><span class="n">add</span>
</code></pre></div></div>

<p>Кроме того, имя main модуля можно задать нгепосредственно</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">main</span>
<span class="s">'tasks'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="p">...</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="n">tasks</span><span class="p">.</span><span class="n">add</span>
</code></pre></div></div>

<h4 id="configuration"><a href="https://docs.celeryproject.org/en/stable/userguide/application.html#configuration">Configuration</a></h4>

<p>Конфиг доступен через <code class="language-plaintext highlighter-rouge">app.conf</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">timezone</span>
<span class="s">'Europe/London'</span>
</code></pre></div></div>

<p>можно задать значения напрямую</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">enable_utc</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>или через апдейт сразу нескольких</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">update</span><span class="p">(</span>
<span class="p">...</span>     <span class="n">enable_utc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">...</span>     <span class="n">timezone</span><span class="o">=</span><span class="s">'Europe/London'</span><span class="p">,</span>
<span class="p">...)</span>
</code></pre></div></div>

<p>Другие способы (к примеру из ф-ла, переменных окружения или из конфигурационного класса) см. в доке. Как правильно писать таски и использовать абстрактные таски для создания собственных, <a href="https://docs.celeryproject.org/en/stable/userguide/application.html#laziness">смотри тут</a>.</p>

<h3 id="tasks"><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html">Tasks</a></h3>

<p>ЗNfcr - это класс, который можно сконструировать из любого вызываемого объекта. Он выполняет двойную роль: определяет что происходит при вызове задачи (отправляет сообщение), и что происходит, когда воркер получает это сообщение.</p>

<p>Каждый класс задач имеет уникальное имя, и на это имя ссылаются в сообщениях, чтобы воркер мог найти нужную функцию для выполнения.</p>

<p>Сообщение таска не удаляется из очереди, пока это сообщение не будет подтверждено воркером. Воркер может заранее зарезервировать множество сообщений, и даже если он прекратит существовать - из-за сбоя питания или по какой-либо другой причине - сообщение будет повторно доставлено другому воркеру.</p>

<p>В идеале функции тасков должны быть идемпотентными: это означает, что <strong>функция не будет вызывать непредвиденных эффектов, даже если вызывается несколько раз с одними и теми же аргументами</strong>. Поскольку рабочий процесс не может определить, являются ли ваши таски идемпотентными, поведение по умолчанию заключается в том, чтобы заранее подтвердить сообщение, непосредственно перед его выполнением. Тогда вызов таска, который уже был запущен, никогда не выполнялся снова.</p>

<p>Если ваша задача идемпотентна, вы можете установить опцию acks_late, чтобы вместо этого воркер подтвердил сообщение после того, как задача вернется.</p>

<p>Обратите внимание, что воркер подтвердит сообщение, если дочерний процесс, выполняющий задачу, будет завершен (либо задачей, вызывающей sys.exit (), либо сигналом), даже если acks_late включен. Такое поведение преднамеренно, поскольку мы не хотим повторно запускать таски, которые заставляют ядро ​​отправлять SIGSEGV (ошибка сегментации) или аналогичные сигналы процессу … и мы предполагаем, что системный администратор, намеренно завершающий задачу, не хочет ее автоматического перезапуска.</p>

<p>Таск, который выделяет слишком много памяти, рискует скрашить ядро, то же самое может произойти снова. Таск, который всегда завершается ошибкой при повторной доставке, может вызвать высокочастотный цикл передачи сообщений, приводящий к остановке системы.</p>

<p>Если вы действительно хотите, чтобы задача была повторно доставлена ​​в этих сценариях, вам следует рассмотреть возможность включения параметра task_reject_on_worker_lost.</p>

<h4 id="базовые-принципы"><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#basics">Базовые принципы</a></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s">'json'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</code></pre></div></div>

<p>В данном случае при создании таска использовалась <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#list-of-options">опция</a> - смотри список опций для тасков.</p>

<p><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#bound-tasks">Bound task</a> - это такие таски, в которых первый аргумент это всегда инстанс таска (self), так же как в методах #python</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div></div>

<p>Возможно наследование таска от базового класса</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">celery</span>

<span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">celery</span><span class="p">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">einfo</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'{0!r} failed: {1!r}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">raise</span> <span class="nb">KeyError</span><span class="p">()</span>
</code></pre></div></div>

<p>У каждого таска должно быть уникальное имя. Если имя не задано - оно будет сгенерировано из имени модуля и имени функции</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'sum-of-two-numbers'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="s">'sum-of-two-numbers'</span>
</code></pre></div></div>

<p>Лучшая практика - использовать имя модуля как неймспейс для имени таска. В данном случае задано такое же имя, какое могло бы быть сгенерировано автоматически для таска, заданного в модуле tasks.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'tasks.add'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">.</span><span class="n">name</span>
<span class="s">'tasks.add'</span>
</code></pre></div></div>

<p>Вопрос автонейминга и релятивного импорта описан <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#automatic-naming-and-relative-imports">тут</a>. Как менять схему автонейминга описано <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#changing-the-automatic-naming-behavior">тут</a>.</p>

<p>Task Request содержит <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-request">информацию</a> и состояние текущего таска. Подробнее о полях смотри в доке.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s">'Executing task id {0.id}, args: {0.args!r} kwargs: {0.kwargs!r}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>Воркер может автоматически логировать данные. Это можно настроить вручную. <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#logging">Подробнее</a>. Лучшая практика - создать простой логгер для всех тасков в модуле:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_task_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Adding {0} + {1}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</code></pre></div></div>

<p>Селери использует стандартную питоню библиотеку для логирования. [<a href="../lists/python-logging" title="Python-logging">python-logging</a>]</p>

<p><code class="language-plaintext highlighter-rouge">app.Task.retry()</code> используется для извлечения таска, например для того, чтобы <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#retrying">поднять ошибку</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="p">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="p">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="p">.</span><span class="n">LoginError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="p">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div></div>

<p>Подробнее читай <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#retrying">в доке</a>.</p>

<p>Celery может <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#states">хранить состояние текущего таска</a> - это результат задачи или поднятая ошибка. Реализовано несколько бекендов для резалтов, <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-result-backends">смотри чем они отличаются тут</a>.</p>

<p>Можно поднять несколько экцепшенов, которые <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#semipredicates">обеспечат определенное поведение воркера</a> для записи финального состояния. Это позволяет игнорить или отклонять таски.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.exceptions</span> <span class="kn">import</span> <span class="n">Ignore</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">some_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">redis</span><span class="p">.</span><span class="n">ismember</span><span class="p">(</span><span class="s">'tasks.revoked'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</code></pre></div></div>

<p>Кроме того, можно задавать <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#custom-task-classes">кастомные классы</a> для тасков, отнаследовавшись от базового <code class="language-plaintext highlighter-rouge">Task</code></p>

<p>Можно <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#ignore-results-you-don-t-want">игнорить резалт таска</a>, если он неважен. Есть и другие способы <a href="https://docs.celeryproject.org/en/stable/userguide/optimizing.html#guide-optimizing">оптимизировать производительность</a>.</p>

<p>Если нужно организовать таски последовательно, это может привести к непредвиденным задержкам в выполнении цепочки. Лучше организовать цепочку <a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#avoid-launching-synchronous-subtasks">асинхронно</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c1"># fetch_page -&gt; parse_page -&gt; store_page
</span>    <span class="n">chain</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">|</span> <span class="n">parse_page</span><span class="p">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">store_page_info</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">chain</span><span class="p">()</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="p">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store_page_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-example">Пример использования тасков для фильтрации спама на джанго тут</a></p>

<h3 id="calling-tasks"><a href="https://docs.celeryproject.org/en/stable/userguide/calling.html">Calling tasks</a></h3>

<p><code class="language-plaintext highlighter-rouge">T.delay(arg, kwarg=value)</code>
Star arguments shortcut to .apply_async. (.delay(*args, **kwargs) calls .apply_async(args, kwargs)).</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async((arg,), {'kwarg': value})</code></p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(countdown=10)</code>
executes in 10 seconds from now.</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(eta=now + timedelta(seconds=10))</code>
executes in 10 seconds from now, specified using eta</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(countdown=60, expires=120)</code>
executes in one minute from now, but expires after 2 minutes.</p>

<p><code class="language-plaintext highlighter-rouge">T.apply_async(expires=now + timedelta(days=2))</code>
expires in 2 days, set using datetime.</p>

<p>Поддерживаются <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#linking-callbacks-errbacks">слинкованные таски</a>, <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#on-message">сборщик состояний</a> таска, <a href="https://docs.celeryproject.org/en/stable/userguide/calling.html#eta-and-countdown">утсановка</a> времени срабатывания и экспирейшен, а так-же жругие опции, включая сборщики ошибок, сжатие и т.д.</p>

<p>Другой способ выполнения тасков - <a href="https://docs.celeryproject.org/en/stable/userguide/canvas.html">построение воркфлоу через signature</a></p>

<h3 id="workers"><a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#workers-guide">Workers</a></h3>

<p>Самый простой способ запустить воркера - <code class="language-plaintext highlighter-rouge">celery -A proj worker -l INFO</code></p>

<p>Можно запускать множество воркеров</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>celery <span class="nt">-A</span> proj worker <span class="nt">--loglevel</span><span class="o">=</span>INFO <span class="nt">--concurrency</span><span class="o">=</span>10 <span class="nt">-n</span> worker1@%h
<span class="nv">$ </span>celery <span class="nt">-A</span> proj worker <span class="nt">--loglevel</span><span class="o">=</span>INFO <span class="nt">--concurrency</span><span class="o">=</span>10 <span class="nt">-n</span> worker2@%h
<span class="nv">$ </span>celery <span class="nt">-A</span> proj worker <span class="nt">--loglevel</span><span class="o">=</span>INFO <span class="nt">--concurrency</span><span class="o">=</span>10 <span class="nt">-n</span> worker3@%h
</code></pre></div></div>

<p>Воркера можно <a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#stopping-the-worker">завершить</a> или <a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#restarting-the-worker">рестартнуть</a>. Все остальное смотри в <a href="https://docs.celeryproject.org/en/stable/userguide/workers.html#workers-guide">документации</a></p>

<h3 id="запуск-демонов"><a href="https://docs.celeryproject.org/en/stable/userguide/daemonizing.html">Запуск демонов</a></h3>

<h3 id="периодически-запускаемые-таски"><a href="https://docs.celeryproject.org/en/stable/userguide/periodic-tasks.html">Периодически запускаемые таски</a></h3>

<h3 id="routing-tasks"><a href="https://docs.celeryproject.org/en/stable/userguide/routing.html">Routing Tasks</a></h3>

<h3 id="monitoring-and-management-guide"><a href="https://docs.celeryproject.org/en/stable/userguide/monitoring.html">Monitoring and Management Guide</a></h3>

<h3 id="security"><a href="https://docs.celeryproject.org/en/stable/userguide/security.html">Security</a></h3>

<h3 id="optimizing"><a href="https://docs.celeryproject.org/en/stable/userguide/optimizing.html">Optimizing</a></h3>

<h3 id="debugging"><a href="https://docs.celeryproject.org/en/stable/userguide/debugging.html">Debugging</a></h3>

<h3 id="concurrency"><a href="https://docs.celeryproject.org/en/stable/userguide/concurrency/index.html">Concurrency</a></h3>

<h3 id="signals"><a href="https://docs.celeryproject.org/en/stable/userguide/signals.html">Signals</a></h3>

<h3 id="testing-with-celery"><a href="https://docs.celeryproject.org/en/stable/userguide/testing.html">Testing with Celery</a></h3>

<h3 id="extensions-and-bootsteps"><a href="https://docs.celeryproject.org/en/stable/userguide/extending.html">Extensions and Bootsteps</a></h3>

<h3 id="configuration-and-defaults"><a href="https://docs.celeryproject.org/en/stable/userguide/configuration.html">Configuration and defaults</a></h3>

<p>Мониторить celery можно через [<a href="flower" title="Flower">flower</a>]</p>



<div class="additional-pad">
  <p><a href="/myknowlegebase/">>>> На главную</a></p>
</div>


    </main>

    <footer role="banner">
    <div class="container">
        <h4><a href="/myknowlegebase/">My knowlege base</a> поддерживается <a href="https://github.com/KonstantinKlepikov">KonstantinKlepikov</a></h4>
        <h4>Блог автора: <a href="https://konstantinklepikov.github.io/">My deep learning</a></h4>
    </div>
</footer>

  </body>

</html>

<script type="text/javascript">
  // Hack: Replace page-link with "Page Title"
  document.querySelectorAll(".markdown-body a[title]").forEach((a) => {
    a.innerText = a.title;
  });
  // Hack: Remove .md extension from wikilinks to get the html in jekyll
  document.querySelectorAll("a").forEach(l => {
    if (l.href.endsWith('.md')) {
      l.href = l.href.substring(0, l.href.length-3)
    }
  })
</script>