<!DOCTYPE html>
<html lang="ru-RU">

<html>

  <head>

    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Unittest | My knowlege base</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Unittest" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Тестирование с помозью unittest в python" />
<meta property="og:description" content="Тестирование с помозью unittest в python" />
<link rel="canonical" href="https://konstantinklepikov.github.io/myknowlegebase/notes/unittest.html" />
<meta property="og:url" content="https://konstantinklepikov.github.io/myknowlegebase/notes/unittest.html" />
<meta property="og:site_name" content="My knowlege base" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://konstantinklepikov.github.io/myknowlegebase/notes/unittest.html","headline":"Unittest","description":"Тестирование с помозью unittest в python","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style"
        type="text/css" crossorigin>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    
    
    <link rel="stylesheet" href="https://konstantinklepikov.github.io/myknowlegebase/assets/css/style.css">

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->


  <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(53548570, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/53548570" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139620627-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-139620627-1');
  </script>


<!-- Favicon -->
<link rel="icon" href="/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">

<!-- Math support -->
<!-- Mathjax Support -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->

</head>

  <body>

    <header role="banner">
    <div class="container">
        <h1 id="a-title"><a href="/myknowlegebase/">My knowledge base</a></h1>
        <h2 class="project-tagline">Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения</h2>
        <p>Тут собраны заметки по программированию, машинному обучению и алгоритмам, которые автор <a href=""></a> делал и продолжает делать в процессе обучения. Тысяча извинений за сумбурность записей, орфографию и изрядную долю копипасты. По сути это конспект. Более толковые статьи можно почитать в блоге <a href="https://konstantinklepikov.github.io/">my deep learning</a></p>
    </div>
</header>

    <main id="main-content" class="container" role="main">

      <h1 id="unittest">Unittest</h1>

<p>Поддерживает все концепции тестирующего программного комплекса, описанного в [<a href="../lists/тестирование" title="Основные принципы тестровния">тестирование</a>]</p>

<p><a href="https://docs.python.org/3/library/unittest.html#command-line-options">Опции командной строки</a></p>

<p><code class="language-plaintext highlighter-rouge">python -m unittest -v test_module</code> с детализацией в отчете</p>

<p><code class="language-plaintext highlighter-rouge">--locals</code> показать локальные переменные в выводе теста</p>

<p><a href="https://docs.python.org/3/library/unittest.html#test-discovery">Test discovery</a> позволяет задать путь, с которого начинается поиск тестов. Кроме того, можно установить паттерн наименований тестов.</p>

<h2 id="структура-кода">Структура кода</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">DefaultWidgetSizeTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_default_widget_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">(</span><span class="s">'The widget'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
</code></pre></div></div>

<p>Используется <code class="language-plaintext highlighter-rouge">TestCase</code> или <code class="language-plaintext highlighter-rouge">FunctionTestCase</code> (для легаси). Unittest распознает как фейлы только собственные ассерты, предоставленные классом <code class="language-plaintext highlighter-rouge">TestCase</code>. В наборе есть сравнение успешных и неуспещных случаев, приблизительное сравнение, а так-же специальные методы для сравнения контейнеров (к примеру списков). <a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertEqual">Полный список тут</a>. Все остальные ассерты идентифицируются как ошибки.</p>

<p>Для каждого теста мы можем задать как собственные сетапы/тирдауны так и для всех тестов сразу. Порядок запуска тестов определяется сортировкой по имени. Тирдаун и тирап запускаются вне зависимости от результатов теста.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">WidgetTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">(</span><span class="s">'The widget'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">widget</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
</code></pre></div></div>

<p>С помощью <code class="language-plaintext highlighter-rouge">TestSuite</code> класса можно <a href="https://docs.python.org/3/library/unittest.html#unittest.TestSuite">группировать тесты</a> для запуска (unittest делает это и самостоятельно, обнаруживая тесты по именам)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">suite</span><span class="p">():</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="p">.</span><span class="n">TestSuite</span><span class="p">()</span>
    <span class="n">suite</span><span class="p">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">WidgetTestCase</span><span class="p">(</span><span class="s">'test_default_widget_size'</span><span class="p">))</span>
    <span class="n">suite</span><span class="p">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">WidgetTestCase</span><span class="p">(</span><span class="s">'test_widget_resize'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">suite</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="p">.</span><span class="n">TextTestRunner</span><span class="p">()</span>
    <span class="n">runner</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="re-using-old-test-code"><a href="https://docs.python.org/3/library/unittest.html#re-using-old-test-code">Re-using old test code</a></h2>

<h2 id="skipping-tests-and-expected-failures"><a href="https://docs.python.org/3/library/unittest.html#skipping-tests-and-expected-failures">Skipping tests and expected failures</a></h2>

<p>Можно скипать тесты как безусловно так и при условии. Классы тоже могут быть заскипаны.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="o">@</span><span class="n">unittest</span><span class="p">.</span><span class="n">skip</span><span class="p">(</span><span class="s">"demonstrating skipping"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fail</span><span class="p">(</span><span class="s">"shouldn't happen"</span><span class="p">)</span>

    <span class="o">@</span><span class="n">unittest</span><span class="p">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">mylib</span><span class="p">.</span><span class="n">__version__</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                     <span class="s">"not supported in this library version"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Tests that work for only a certain version of the library.
</span>        <span class="k">pass</span>

    <span class="o">@</span><span class="n">unittest</span><span class="p">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">platform</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"win"</span><span class="p">),</span> <span class="s">"requires Windows"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_windows_support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># windows specific testing code
</span>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">test_maybe_skipped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_resource_available</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s">"external resource not available"</span><span class="p">)</span>
        <span class="c1"># test code that depends on the external resource
</span>        <span class="k">pass</span>
</code></pre></div></div>

<h2 id="сабтесты"><a href="https://docs.python.org/3/library/unittest.html#distinguishing-test-iterations-using-subtests">Сабтесты</a></h2>

<p>Используется, к примеру, когда разница между тестами небольшая. Например когда тестируется определенный ренж значений для объекта тестирования. Это позволяет увидеть все фейлы (иначе тест фейлится на первом кейсе. Это полезно, когда надо тестировать одну и туже логику с различными данными - когда мы ожидаем одинакового результата, но часть тестов падает.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>


<span class="k">class</span> <span class="nc">SubTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_with_subtest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span> <span class="s">'B'</span><span class="p">,</span> <span class="s">'c'</span><span class="p">,</span> <span class="s">'d'</span><span class="p">]:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pat</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="s">'abc'</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="api-unittest">API unittest</h2>

<h3 id="test-cases"><a href="https://docs.python.org/3/library/unittest.html#test-cases">Test cases</a></h3>

<p>Методы в <code class="language-plaintext highlighter-rouge">TestCase</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">setUp()</code> реализует предоставление разделяемого ресурса</li>
  <li><code class="language-plaintext highlighter-rouge">tearDown()</code> освобождает разделяемый ресурс</li>
  <li><code class="language-plaintext highlighter-rouge">setUpClass()</code> устанавливает разделяемые ресурсы для класса</li>
  <li><code class="language-plaintext highlighter-rouge">tearDownClass()</code> освобождает ресурсы для класса</li>
  <li><code class="language-plaintext highlighter-rouge">setUpModule()</code></li>
  <li><code class="language-plaintext highlighter-rouge">tearDownModule()</code></li>
  <li><code class="language-plaintext highlighter-rouge">run(result=None)</code></li>
  <li><code class="language-plaintext highlighter-rouge">skipTest(reason)</code></li>
  <li><code class="language-plaintext highlighter-rouge">subTest(msg=None, **params)</code></li>
  <li><code class="language-plaintext highlighter-rouge">debug()</code> тест запускается без агрегации результата</li>
</ul>

<p>Подробнее смотри <a href="https://docs.python.org/3/library/unittest.html#class-and-module-fixtures">Class and module fixtures</a></p>

<p>Обычно сетапы и тирдауны выносятся в отельный класс, наследуемый от <code class="language-plaintext highlighter-rouge">TestCase</code>, от которого уже могут наследоваться конкретные тесты. Пример:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyUnitTests</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="s">"""Unit tests basic
    """</span>
    
    <span class="k">def</span> <span class="nf">setTestingEngine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="s">"""Set temporal base
        """</span> 
        <span class="p">[...]</span>

    <span class="k">def</span> <span class="nf">setTemporalBase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Set temporal data to base for tests
        """</span>
        <span class="p">[...]</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""start test server
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">setTestingEngine</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">setTemporalBase</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">uvicorn</span><span class="p">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">app</span><span class="p">,),</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                                <span class="s">'host'</span><span class="p">:</span> <span class="n">ALLOWED_HOSTS</span><span class="p">,</span>
                                <span class="s">'port'</span><span class="p">:</span> <span class="n">PORT</span><span class="p">,</span>
                                <span class="s">'debug'</span><span class="p">:</span> <span class="n">DEBUG</span><span class="p">,</span>
                                <span class="s">'log_level'</span><span class="p">:</span> <span class="s">'info'</span><span class="p">},</span>
                            <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">proc</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="p">.</span><span class="n">client</span><span class="p">:</span>
            <span class="p">[...]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop test server
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">proc</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
</code></pre></div></div>

<p>Если в процессе очистки ресурсов упадет ошибка, не все ресурсы могут быть освобождены. Чтобы избежать этой проблемы можно добавить <code class="language-plaintext highlighter-rouge">addCleanup()</code>, которая будет вызываться после <code class="language-plaintext highlighter-rouge">tearDown()</code>. Если <code class="language-plaintext highlighter-rouge">setUp()</code> завершается ошибкой, что означает, что <code class="language-plaintext highlighter-rouge">tearDown()</code> не вызывается, то любые добавленные функции очистки все равно будут вызываться.</p>

<p><code class="language-plaintext highlighter-rouge">doClenups()</code> вызывается безоговорочно после <code class="language-plaintext highlighter-rouge">tearDown()</code> или после <code class="language-plaintext highlighter-rouge">setUp()</code>, если <code class="language-plaintext highlighter-rouge">setUp()</code> вызывает исключение. Он отвечает за вызов всех функций очистки, добавленных функцией <code class="language-plaintext highlighter-rouge">addCleanup()</code>. Если вам нужно, чтобы функции очистки вызывались до <code class="language-plaintext highlighter-rouge">tearDown()</code>, вы можете сами вызвать <code class="language-plaintext highlighter-rouge">doCleanups()</code>. <code class="language-plaintext highlighter-rouge">doCleanups()</code> извлекает методы из стека функций очистки по одному, поэтому ее можно вызвать в любое время.</p>

<p>Есть функции, доступные на урвоне класса и модуля. Смотри <a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.addCleanup">подробности тут</a></p>

<h3 id="тестирование-неудачных-случаев">Тестирование неудачных случаев</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">SomeException</span><span class="p">):</span>
    <span class="n">do_something</span><span class="p">()</span>

<span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">SomeException</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">()</span>

<span class="n">the_exception</span> <span class="o">=</span> <span class="n">cm</span><span class="p">.</span><span class="n">exception</span>
<span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">the_exception</span><span class="p">.</span><span class="n">error_code</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertRaises">Документация из юниттеста по райзес</a></p>

<h3 id="тестирование-асинхронного-кода"><a href="https://docs.python.org/3/library/unittest.html#unittest.IsolatedAsyncioTestCase">Тестирование асинхронного кода</a></h3>

<h3 id="группировка-тестов"><a href="https://docs.python.org/3/library/unittest.html#grouping-tests">Группировка тестов</a></h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">addTest(test)</code></li>
  <li><code class="language-plaintext highlighter-rouge">addTests(test)</code></li>
  <li><code class="language-plaintext highlighter-rouge">run(result)</code></li>
  <li><code class="language-plaintext highlighter-rouge">run()</code></li>
  <li><code class="language-plaintext highlighter-rouge">debug()</code></li>
  <li><code class="language-plaintext highlighter-rouge">__iter__()</code></li>
</ul>

<p>используется для загрузки тестов из пакетов и модулей.</p>

<h3 id="тестлоадеры-и-запуск-тестов"><a href="https://docs.python.org/3/library/unittest.html#loading-and-running-tests">Тестлоадеры и запуск тестов</a></h3>

<h3 id="load-test-protocol"><a href="https://docs.python.org/3/library/unittest.html#load-tests-protocol">load test protocol</a></h3>

<h2 id="signal-handling"><a href="https://docs.python.org/3/library/unittest.html#signal-handling">Signal Handling</a></h2>

<hr />

<ul>
  <li>[<a href="pytest" title="Pytest">pytest</a>]</li>
  <li>[<a href="doctest" title="Doctest">doctest</a>]</li>
  <li>[<a href="../lists/тестирование" title="Основные принципы тестровния">тестирование</a>]</li>
  <li>[<a href="../posts/2021-04-02-daily-note" title="Про работу behave и unittest и немного про datetime">2021-04-02-daily-note</a>]</li>
  <li>[<a href="mock" title="Mock-тесты">mock</a>]</li>
</ul>



<div class="additional-pad">
  <p><a href="/myknowlegebase/">>>> На главную</a></p>
</div>


    </main>

    <footer role="banner">
    <div class="container">
        <h4><a href="/myknowlegebase/">My knowlege base</a> поддерживается <a href="https://github.com/KonstantinKlepikov">KonstantinKlepikov</a></h4>
        <h4>Блог автора: <a href="https://konstantinklepikov.github.io/">My deep learning</a></h4>
    </div>
</footer>

  </body>

</html>

<script type="text/javascript">
  // Hack: Replace page-link with "Page Title"
  document.querySelectorAll(".markdown-body a[title]").forEach((a) => {
    a.innerText = a.title;
  });
  // Hack: Remove .md extension from wikilinks to get the html in jekyll
  document.querySelectorAll("a").forEach(l => {
    if (l.href.endsWith('.md')) {
      l.href = l.href.substring(0, l.href.length-3)
    }
  })
</script>