<!DOCTYPE html>
<html lang="ru-RU">

<html>

  <head>

    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Fastapi environment variables | My knowlege base</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Fastapi environment variables" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения" />
<meta property="og:description" content="Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения" />
<link rel="canonical" href="https://konstantinklepikov.github.io/myknowlegebase/notes/fastapi-setting-environment-variables.html" />
<meta property="og:url" content="https://konstantinklepikov.github.io/myknowlegebase/notes/fastapi-setting-environment-variables.html" />
<meta property="og:site_name" content="My knowlege base" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://konstantinklepikov.github.io/myknowlegebase/notes/fastapi-setting-environment-variables.html","headline":"Fastapi environment variables","description":"Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style"
        type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    
    
    <link rel="stylesheet" href="https://konstantinklepikov.github.io/myknowlegebase/assets/css/style.css">

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->


<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/myknowlegebase/favicon.ico" -->

<!-- Math support -->
<!-- Mathjax Support -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->

</head>

  <body>

    <header class="page-header" role="banner">
    <h1 class="project-name">My knowlege base</h1>
    <h2 class="project-tagline">Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения</h2>
    <p class="project-tagline">Блог автора: <a class="project-tagline header-links" href="https://konstantinklepikov.github.io/">My deep learning</a></p>
</header>

    <main id="content" class="main-content" role="main">

      <p><a href="/myknowlegebase/">На главную</a></p>

<h1 id="fastapi-environment-variables">Fastapi environment variables</h1>

<p><a href="https://fastapi.tiangolo.com/pt/advanced/settings/">Основная статья</a></p>

<p>Прочитать переменные окружения в python можно так</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>

<span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">"MY_NAME"</span><span class="p">,</span> <span class="s">"World"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">f"Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> from Python"</span><span class="p">)</span>
</code></pre></div></div>

<p>Переменные окружения - это всегда строго строки. Валидировать их можно в [<a href="pydantic" title="Pydantic">pydantic</a>] через импорт <code class="language-plaintext highlighter-rouge">BaseSettings</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseSettings</span>


<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"Awesome API"</span>
    <span class="n">admin_email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">items_per_user</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>


<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/info"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">info</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"app_name"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">app_name</span><span class="p">,</span>
        <span class="s">"admin_email"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">admin_email</span><span class="p">,</span>
        <span class="s">"items_per_user"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">items_per_user</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Теперь мы можем создать инстанс этого класса и читать переменные окружения, валидируя их. Для этого надо запустить сервер с нужно конфигурацией:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ADMIN_EMAIL</span><span class="o">=</span><span class="s2">"deadpool@example.com"</span> <span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"ChimichangApp"</span> uvicorn main:app

INFO: Uvicorn running on http://127.0.0.1:8000 <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
</code></pre></div></div>

<p>Теперь <code class="language-plaintext highlighter-rouge">admin_email</code> установлен в “deadpool@example.com” ну и т.д.</p>

<p>Кроме того мы можем создать сеттинги как зависимость, импортировать их в другой модуль и использовать в функции</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="o">@</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_settings</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">config</span><span class="p">.</span><span class="n">Settings</span><span class="p">()</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/info"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">Settings</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_settings</span><span class="p">)):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"app_name"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">app_name</span><span class="p">,</span>
        <span class="s">"admin_email"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">admin_email</span><span class="p">,</span>
        <span class="s">"items_per_user"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">items_per_user</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>В дапнном случае мы внедрили зависимость от get_settings(), которая в свою очередь возвращает переменные окружения.</p>

<p>Наконец мы можем переопределить [<a href="fastapi-testing-dependencies-with-override" title="Fastapi testing dependencies with owerride">fastapi-testing-dependencies-with-override</a>] зависимости и в них переменные для [<a href="../lists/тестирование" title="Основные принципы тестровния">тестирование</a>]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fastapi.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">main</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">main</span><span class="p">.</span><span class="n">app</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_settings_override</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">config</span><span class="p">.</span><span class="n">Settings</span><span class="p">(</span><span class="n">admin_email</span><span class="o">=</span><span class="s">"testing_admin@example.com"</span><span class="p">)</span>


<span class="n">main</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">main</span><span class="p">.</span><span class="n">get_settings</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_settings_override</span>


<span class="k">def</span> <span class="nf">test_app</span><span class="p">():</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/info"</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s">"app_name"</span><span class="p">:</span> <span class="s">"Awesome API"</span><span class="p">,</span>
        <span class="s">"admin_email"</span><span class="p">:</span> <span class="s">"testing_admin@example.com"</span><span class="p">,</span>
        <span class="s">"items_per_user"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="reading-a-env-file"><a href="https://fastapi.tiangolo.com/pt/advanced/settings/#reading-a-env-file">Reading a .env file</a></h2>

<p>В [<a href="pydantic" title="Pydantic">pydantic</a>] есть <a href="https://pydantic-docs.helpmanual.io/usage/settings/#dotenv-env-support">поддержка .env</a>. Нужно поставить <code class="language-plaintext highlighter-rouge">pip install dotenv</code> и добавить .env в конфиги</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseSettings</span>


<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"Awesome API"</span>
    <span class="n">admin_email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">items_per_user</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">env_file</span> <span class="o">=</span> <span class="s">".env"</span>
</code></pre></div></div>

<h2 id="lru_cash">lru_cash()</h2>

<p>Все переменные можно задать один раз для всего</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="o">@</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_settings</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">config</span><span class="p">.</span><span class="n">Settings</span><span class="p">()</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/info"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">Settings</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_settings</span><span class="p">)):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"app_name"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">app_name</span><span class="p">,</span>
        <span class="s">"admin_email"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">admin_email</span><span class="p">,</span>
        <span class="s">"items_per_user"</span><span class="p">:</span> <span class="n">settings</span><span class="p">.</span><span class="n">items_per_user</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">lru_cash()</code> модифицирует декорируемую функцию так, чтобы при последующих вычислениях возвращать результат первого вычисления при условии, что входные данные или функция не обновились.</p>

<p><a href="https://docs.python.org/3/library/functools.html#functools.lru_cache">Подробнее про lru_cashe()</a></p>

<ul>
  <li>[<a href="../lists/fastapi" title="Аastapi">fastapi</a>]</li>
  <li>[<a href="fastapi-testing-dependencies-with-override" title="Fastapi testing dependencies with owerride">fastapi-testing-dependencies-with-override</a>]</li>
</ul>



<div class="additional-pad">
  <p><a href="/myknowlegebase/">На главную</a></p>
</div>


      <footer class="site-footer">
    
    <span class="site-footer-owner"><a href="https://github.com/KonstantinKlepikov/myknowlegebase">myknowlegebase</a> поддерживается <a href="https://github.com/KonstantinKlepikov">KonstantinKlepikov</a></span>
    
    <span class="site-footer-credits">Блог автора: <a href="https://konstantinklepikov.github.io/">My deep learning</a></span>
</footer>

    </main>

  </body>

</html>

<script type="text/javascript">
  // Hack: Replace page-link with "Page Title"
  document.querySelectorAll(".markdown-body a[title]").forEach((a) => {
    a.innerText = a.title;
  });
  // Hack: Remove .md extension from wikilinks to get the html in jekyll
  document.querySelectorAll("a").forEach(l => {
    if (l.href.endsWith('.md')) {
      l.href = l.href.substring(0, l.href.length-3)
    }
  })
</script>