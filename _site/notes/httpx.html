<!DOCTYPE html>
<html lang="ru_RU">

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>httpx cинхронный и асинхронный http-клиент | My knowledge base</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="httpx cинхронный и асинхронный http-клиент" />
<meta property="og:locale" content="ru_RU" />
<meta name="description" content="Sync and async HTTP 1/2 Client for Python3" />
<meta property="og:description" content="Sync and async HTTP 1/2 Client for Python3" />
<link rel="canonical" href="https://konstantinklepikov.github.io/myknowlegebase/notes/httpx.html" />
<meta property="og:url" content="https://konstantinklepikov.github.io/myknowlegebase/notes/httpx.html" />
<meta property="og:site_name" content="My knowledge base" />
<script type="application/ld+json">
{"description":"Sync and async HTTP 1/2 Client for Python3","@type":"WebPage","url":"https://konstantinklepikov.github.io/myknowlegebase/notes/httpx.html","headline":"httpx cинхронный и асинхронный http-клиент","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="keywords" content="">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    
    
    <link rel="stylesheet" href="https://konstantinklepikov.github.io/myknowlegebase/assets/style.css">
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->


      <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(53548570, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/53548570" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
      <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139620627-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-139620627-1');
  </script>


<!-- Favicon -->
<link rel="icon" href="https://konstantinklepikov.github.io/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="https://konstantinklepikov.github.io/myknowlegebase/assets/img/favicon.ico" type="image/x-icon">

<!-- Math support -->
<!-- Mathjax Support -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- tags collection-->

    







<!-- end custom head snippets -->

</head>

  <body>

    <header class="border-bottom-thick px-2 clearfix">
    <div class="left sm-width-full py-1 mt-1 mt-lg-0">
      <a class="align-middle link-primary text-accent" href="https://konstantinklepikov.github.io/">
        My deep learning
      </a>
    </div>
    <div class="right sm-width-full">
      <ul class="list-reset mt-lg-1 mb-2 mb-lg-1">
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/myknowlegebase/">
            My knowledge base
          </a>
        </li>
      </ul>
    </div>
  </header>

    <main role="main">

      
<article class="container mx-auto px-2 mt2 mb4">
  <header>
    <h1 class="h1 col-9 sm-width-full py-4 mt-3 inline-block" itemprop="name headline">httpx cинхронный и асинхронный http-клиент</h1>
  </header>
  <div class="col-4 sm-width-full border-top-thin">
    <p class="mb-3 h5">Теги:
      
        
        <a href="/myknowlegebase/tag/http" title="http" class="link-tags">http&nbsp;</a>
      
        
        <a href="/myknowlegebase/tag/asyncio" title="asyncio" class="link-tags">asyncio&nbsp;</a>
      
        
        <a href="/myknowlegebase/tag/python" title="python" class="link-tags">python&nbsp;</a>
      
    </p>
  </div>
  <div class="prose mb-4 py-4">
    <p>HTTPX is a fully featured HTTP client for Python 3, which provides sync and async APIs, and support for both HTTP/1.1 and HTTP/2.</p>

<p><code class="language-plaintext highlighter-rouge">pip install httpx</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">httpx</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.example.org/'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span>
<span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">200</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'content-type'</span><span class="p">]</span>
<span class="s">'text/html; charset=UTF-8'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="s">'&lt;!doctype html&gt;</span><span class="se">\n</span><span class="s">&lt;html&gt;</span><span class="se">\n</span><span class="s">&lt;head&gt;</span><span class="se">\n</span><span class="s">&lt;title&gt;Example Domain&lt;/title&gt;...'</span>
</code></pre></div></div>

<h2 id="фичи">Фичи</h2>

<ul>
  <li>Широко совместимый с [<a href="requests" title="Requests">requests</a>] API.</li>
  <li>Стандартный синхронный интерфейс, но с поддержкой асинхронности.</li>
  <li>Поддержка HTTP/1.1 и HTTP/2.</li>
  <li>Возможность делать запросы непосредственно к приложениям WSGI или приложениям ASGI</li>
  <li>Везде строгие тайм-ауты.</li>
  <li>Полностью анотирован.</li>
  <li>100% покрытие тестами.</li>
</ul>

<p>Плюс все стандартные возможности запросов:</p>

<ul>
  <li>Международные домены и URL-адреса</li>
  <li>Keep-Alive и пул соединений</li>
  <li>Сеансы с сохраняемостью файлов cookie</li>
  <li>Проверка SSL в браузер-стиле</li>
  <li>Basic/Digest аутентификация</li>
  <li>Элегантные Key/Value cookie</li>
  <li>Автоматическая декомпрессия</li>
  <li>Автоматическое декодирование контента</li>
  <li>Тело ответа в Unicode</li>
  <li>Загрузка multipart file</li>
  <li>Поддержка прокси-серверов HTTP(S)</li>
  <li>Тайм-ауты подключения</li>
  <li>Потоковые загрузки</li>
  <li>Поддержка .netrc</li>
  <li>Разделенные (chunked) запросы</li>
</ul>

<h2 id="зависимости">Зависимости</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">httpcore</code> - The underlying transport implementation for httpx.</li>
  <li><code class="language-plaintext highlighter-rouge">h11</code> - HTTP/1.1 support.</li>
  <li><code class="language-plaintext highlighter-rouge">certifi</code> - SSL certificates.</li>
  <li><code class="language-plaintext highlighter-rouge">rfc3986</code> - URL parsing &amp; normalization.</li>
  <li><code class="language-plaintext highlighter-rouge">idna</code> - Internationalized domain name support.</li>
  <li><code class="language-plaintext highlighter-rouge">sniffio</code> - Async library autodetection.</li>
</ul>

<p>Дополнительно:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">h2</code> - HTTP/2 support. (Optional, with <code class="language-plaintext highlighter-rouge">httpx[http2]</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">socksio</code> - SOCKS proxy support. (Optional, with <code class="language-plaintext highlighter-rouge">httpx[socks]</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">rich</code> - Rich terminal support. (Optional, with <code class="language-plaintext highlighter-rouge">httpx[cli]</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">click</code> - Command line client support. (Optional, with <code class="language-plaintext highlighter-rouge">httpx[cli]</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">brotli</code> or <code class="language-plaintext highlighter-rouge">brotlicffi</code> - Decoding for “brotli” compressed responses. (Optional, with <code class="language-plaintext highlighter-rouge">httpx[brotli]</code>)</li>
</ul>

<h2 id="basicusage"><a href="https://www.python-httpx.org/quickstart/">BasicUsage</a></h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">httpx</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/get'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span>
<span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">'https://httpbin.org/put'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'key'</span><span class="p">:</span> <span class="s">'value'</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="s">'https://httpbin.org/delete'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="s">'https://httpbin.org/get'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">options</span><span class="p">(</span><span class="s">'https://httpbin.org/get'</span><span class="p">)</span>

<span class="c1"># To include URL query parameters in the request,
# use the params keyword
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'key1'</span><span class="p">:</span> <span class="s">'value1'</span><span class="p">,</span> <span class="s">'key2'</span><span class="p">:</span> <span class="s">'value2'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/get'</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">url</span>
<span class="n">URL</span><span class="p">(</span><span class="s">'https://httpbin.org/get?key2=value2&amp;key1=value1'</span><span class="p">)</span>

<span class="c1"># list of items as a value
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'key1'</span><span class="p">:</span> <span class="s">'value1'</span><span class="p">,</span> <span class="s">'key2'</span><span class="p">:</span> <span class="p">[</span><span class="s">'value2'</span><span class="p">,</span> <span class="s">'value3'</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/get'</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">url</span>
<span class="n">URL</span><span class="p">(</span><span class="s">'https://httpbin.org/get?key1=value1&amp;key2=value2&amp;key2=value3'</span><span class="p">)</span>

<span class="c1"># HTTPX will automatically handle decoding the response
# content into Unicode text
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.example.org/'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="s">'&lt;!doctype html&gt;</span><span class="se">\n</span><span class="s">&lt;html&gt;</span><span class="se">\n</span><span class="s">&lt;head&gt;</span><span class="se">\n</span><span class="s">&lt;title&gt;Example Domain&lt;/title&gt;...'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">encoding</span>
<span class="s">'UTF-8'</span>

<span class="c1"># response may not contain an explicit encoding, in which case
# HTTPX will attempt to automatically determine an encoding to use
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">encoding</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
<span class="s">'&lt;!doctype html&gt;</span><span class="se">\n</span><span class="s">&lt;html&gt;</span><span class="se">\n</span><span class="s">&lt;head&gt;</span><span class="se">\n</span><span class="s">&lt;title&gt;Example Domain&lt;/title&gt;...'</span>

<span class="c1"># verride
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">'ISO-8859-1'</span>

<span class="c1"># binary content
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">content</span>
<span class="s">b'&lt;!doctype html&gt;</span><span class="se">\n</span><span class="s">&lt;html&gt;</span><span class="se">\n</span><span class="s">&lt;head&gt;</span><span class="se">\n</span><span class="s">&lt;title&gt;Example Domain&lt;/title&gt;...'</span>

<span class="c1"># json content
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.github.com/events'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">[{</span><span class="s">u'repository'</span><span class="p">:</span> <span class="p">{</span><span class="s">u'open_issues'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">u'url'</span><span class="p">:</span> <span class="s">'https://github.com/...'</span> <span class="p">...</span>  <span class="p">}}]</span>

<span class="c1"># custom headers
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s">'https://httpbin.org/headers'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'user-agent'</span><span class="p">:</span> <span class="s">'my-app/0.0.1'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="c1"># Sending Form Encoded Data example
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'key1'</span><span class="p">:</span> <span class="s">'value1'</span><span class="p">,</span> <span class="s">'key2'</span><span class="p">:</span> <span class="p">[</span><span class="s">'value1'</span><span class="p">,</span> <span class="s">'value2'</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"https://httpbin.org/post"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="s">"form"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"key2"</span><span class="p">:</span> <span class="s">"value2"</span><span class="p">,</span>
    <span class="s">"key1"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">"value1"</span><span class="p">,</span>
      <span class="s">"value2"</span>
    <span class="p">],</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1"># send json encoded data
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'integer'</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s">'boolean'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'list'</span><span class="p">:</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span> <span class="s">'b'</span><span class="p">,</span> <span class="s">'c'</span><span class="p">]}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"https://httpbin.org/post"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="s">"json"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"boolean"</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s">"integer"</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="s">"list"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">"a"</span><span class="p">,</span>
      <span class="s">"b"</span><span class="p">,</span>
      <span class="s">"c"</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1"># Sending Multipart File Uploads
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s">'upload-file'</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s">'report.xls'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"https://httpbin.org/post"</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="s">"files"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"upload-file"</span><span class="p">:</span> <span class="s">"&lt;... binary content ...&gt;"</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1"># Sending Binary Request Data
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">content</span> <span class="o">=</span> <span class="s">b'Hello, world'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"https://httpbin.org/post"</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># Responses
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/get'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">200</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">httpx</span><span class="p">.</span><span class="n">codes</span><span class="p">.</span><span class="n">OK</span>
<span class="bp">True</span>

<span class="c1"># We can raise an exception for any responses which are not a 2xx success code
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">not_found</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/status/404'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">not_found</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">404</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">not_found</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"/Users/tomchristie/GitHub/encode/httpcore/httpx/models.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">837</span><span class="p">,</span> <span class="ow">in</span> <span class="n">raise_for_status</span>
    <span class="k">raise</span> <span class="n">HTTPStatusError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
<span class="n">httpx</span><span class="p">.</span><span class="n">_exceptions</span><span class="p">.</span><span class="n">HTTPStatusError</span><span class="p">:</span> <span class="mi">404</span> <span class="n">Client</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Not</span> <span class="n">Found</span> <span class="k">for</span> <span class="n">url</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">status</span><span class="o">/</span><span class="mi">404</span>
<span class="n">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">check</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">httpstatuses</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="mi">404</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span>
<span class="n">Headers</span><span class="p">({</span>
    <span class="s">'content-encoding'</span><span class="p">:</span> <span class="s">'gzip'</span><span class="p">,</span>
    <span class="s">'transfer-encoding'</span><span class="p">:</span> <span class="s">'chunked'</span><span class="p">,</span>
    <span class="s">'connection'</span><span class="p">:</span> <span class="s">'close'</span><span class="p">,</span>
    <span class="s">'server'</span><span class="p">:</span> <span class="s">'nginx/1.0.4'</span><span class="p">,</span>
    <span class="s">'x-runtime'</span><span class="p">:</span> <span class="s">'148ms'</span><span class="p">,</span>
    <span class="s">'etag'</span><span class="p">:</span> <span class="s">'"e1ca502697e5c9317743dc078f67693f"'</span><span class="p">,</span>
    <span class="s">'content-type'</span><span class="p">:</span> <span class="s">'application/json'</span>
<span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-Type'</span><span class="p">]</span>
<span class="s">'application/json'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content-type'</span><span class="p">)</span>
<span class="s">'application/json'</span>

<span class="c1"># For large downloads you may want to use streaming responses that do not load the entire response body into memory at once.
</span>
<span class="c1"># binary
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"https://www.example.com"</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_bytes</span><span class="p">():</span>
<span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># text
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"https://www.example.com"</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_text</span><span class="p">():</span>
<span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># or text line by line
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"https://www.example.com"</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_lines</span><span class="p">():</span>
<span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># or raw without decoding
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"https://www.example.com"</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_raw</span><span class="p">():</span>
<span class="p">...</span>         <span class="k">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

<span class="c1"># Cookies
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/cookies/set?chocolate=chip'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">cookies</span><span class="p">[</span><span class="s">'chocolate'</span><span class="p">]</span>
<span class="s">'chip'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://httpbin.org/cookies'</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'cookies'</span><span class="p">:</span> <span class="p">{</span><span class="s">'peanut'</span><span class="p">:</span> <span class="s">'butter'</span><span class="p">}}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Cookies</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cookies</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'cookie_on_domain'</span><span class="p">,</span> <span class="s">'hello, there!'</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s">'httpbin.org'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cookies</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">'cookie_off_domain'</span><span class="p">,</span> <span class="s">'nope.'</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s">'example.org'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://httpbin.org/cookies'</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'cookies'</span><span class="p">:</span> <span class="p">{</span><span class="s">'cookie_on_domain'</span><span class="p">:</span> <span class="s">'hello, there!'</span><span class="p">}}</span>

<span class="c1"># Redirection and hystory
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://github.com/'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">301</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">history</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">next_request</span>
<span class="o">&lt;</span><span class="n">Request</span><span class="p">(</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'https://github.com/'</span><span class="p">)</span><span class="o">&gt;</span>

<span class="c1"># You can modify the default redirection handling with
# the follow_redirects parameter
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://github.com/'</span><span class="p">,</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">url</span>
<span class="n">URL</span><span class="p">(</span><span class="s">'https://github.com/'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span>
<span class="mi">200</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">history</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">301</span> <span class="n">Moved</span> <span class="n">Permanently</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span>

<span class="c1"># Timeouts (default 5s)
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://github.com/'</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://github.com/'</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="c1"># HTTPX supports Basic and Digest HTTP authentication.
</span>
<span class="c1"># Basic
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://example.com"</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">"my_user"</span><span class="p">,</span> <span class="s">"password123"</span><span class="p">))</span>

<span class="c1"># Digest
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">DigestAuth</span><span class="p">(</span><span class="s">"my_user"</span><span class="p">,</span> <span class="s">"password123"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://example.com"</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span><span class="o">&gt;</span>

<span class="c1"># Exceptions
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://www.example.com/"</span><span class="p">)</span>
<span class="k">except</span> <span class="n">httpx</span><span class="p">.</span><span class="n">RequestError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"An error occurred while requesting </span><span class="si">{</span><span class="n">exc</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="err">!</span><span class="n">r</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="advanced-usage"><a href="https://www.python-httpx.org/advanced/">Advanced usage</a></h2>

<p>Если вы делаете что-то большее, чем эксперименты, одноразовые сценарии или прототипы, вам следует использовать экземпляр Client.</p>

<p>Когда вы делаете запросы с помощью API верхнего уровня, как описано в кратком руководстве, HTTPX должен устанавливать новое соединение для каждого отдельного запроса (соединения не используются повторно). По мере увеличения количества запросов к хосту это быстро становится неэффективным.</p>

<p>С другой стороны, экземпляр клиента использует пул HTTP-соединений. Это означает, что когда вы делаете несколько запросов к одному и тому же хосту, клиент будет повторно использовать базовое TCP-соединение вместо того, чтобы заново создавать его для каждого отдельного запроса.</p>

<p>Это может привести к значительному повышению производительности по сравнению с использованием API верхнего уровня, в том числе:</p>

<ul>
  <li>Уменьшенние задержки между запросами</li>
  <li>Снижение загрузки ЦП и количества обращений round-tips.</li>
  <li>Снижение загруженности сети.</li>
</ul>

<p>Экземпляры клиента также поддерживают функции, недоступные в API верхнего уровня, например:</p>

<ul>
  <li>Сохранение файлов cookie между запросами.</li>
  <li>Применение конфигурации ко всем исходящим запросам.</li>
  <li>Отправка запросов через HTTP-прокси.</li>
  <li>Использование HTTP/2.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://example.com'</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span>
<span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Общая конфигурация для запросов (внимательно изучи поведение при мерже глобального конфига и внутри контекста - для разных полей запроса поведение отличается):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s">'http://httpbin.org/headers'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'user-agent'</span><span class="p">:</span> <span class="s">'my-app/0.0.1'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'headers'</span><span class="p">][</span><span class="s">'User-Agent'</span><span class="p">]</span>
<span class="s">'my-app/0.0.1'</span>
</code></pre></div></div>

<p>Достыпны собственные опции конфигурации клиента, к примеру <code class="language-plaintext highlighter-rouge">base_url</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s">'http://httpbin.org'</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/headers'</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">url</span>
<span class="n">URL</span><span class="p">(</span><span class="s">'http://httpbin.org/headers'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="calling-into-python-web-apps">Calling into Python Web Apps</h3>

<p>Вы можете настроить клиент httpx для прямого вызова веб-приложения Python с использованием протокола WSGI.</p>

<p>Это особенно полезно для двух основных вариантов использования:</p>

<ul>
  <li>Использование httpx в качестве клиента внутри тестовых случаев.</li>
  <li>Макетирование внешних сервисов во время тестов или в средах разработки/постановки.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">httpx</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"Hello World!"</span>

<span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s">"http://testserver"</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div></div>

<h3 id="request-instances">Request instances</h3>

<p>Для максимального контроля над тем, что отправляется по сети, HTTPX поддерживает создание явных экземпляров запроса:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"X-Api-Key"</span><span class="p">:</span> <span class="s">"..."</span><span class="p">,</span> <span class="s">"X-Client-ID"</span><span class="p">:</span> <span class="s">"ABC123"</span><span class="p">}</span>

<span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">build_request</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"https://api.example.com"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"X-Client-ID"</span><span class="p">])</span>  <span class="c1"># "ABC123"
</span>
    <span class="c1"># Don't send the API key for this particular request.
</span>    <span class="k">del</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"X-Api-Key"</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>HTTPX позволяет регистрировать «перехватчики событий» у клиента, которые вызываются каждый раз, когда происходит определенный тип события.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Request event hook: </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="s"> - Waiting for response"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">request</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"Response event hook: </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="s"> - Status </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="p">{</span><span class="s">'request'</span><span class="p">:</span> <span class="p">[</span><span class="n">log_request</span><span class="p">],</span> <span class="s">'response'</span><span class="p">:</span> <span class="p">[</span><span class="n">log_response</span><span class="p">]})</span>
</code></pre></div></div>

<h3 id="http-proxying">HTTP Proxying</h3>

<p><img src="/myknowlegebase/attachments/2023-02-14-19-26-41.png" alt="procy" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">proxies</span><span class="o">=</span><span class="s">"http://localhost:8030"</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="p">...</span>

<span class="c1"># or
</span><span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"http://"</span><span class="p">:</span> <span class="s">"http://localhost:8030"</span><span class="p">,</span>
    <span class="s">"https://"</span><span class="p">:</span> <span class="s">"http://localhost:8031"</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>Подробнее в <a href="https://www.python-httpx.org/advanced/#routing">разделе о маршрутизации</a>.</p>

<p>Помимо HTTP-прокси, http также поддерживает прокси, использующие протокол SOCKS. Это необязательная функция, перед использованием которой необходимо установить дополнительную стороннюю библиотеку.</p>

<h3 id="pool-limit">Pool limit</h3>

<p>Вы можете управлять размером пула соединений, используя аргумент <code class="language-plaintext highlighter-rouge">limit</code> в клиенте. Он принимает экземпляры <code class="language-plaintext highlighter-rouge">httpx.Limits</code>, которые определяют:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">max_keepalive_connections</code>, количество допустимых соединений <code class="language-plaintext highlighter-rouge">keep-alive</code> или <code class="language-plaintext highlighter-rouge">None</code>, чтобы всегда разрешать (по умолчанию 20)</li>
  <li><code class="language-plaintext highlighter-rouge">max_connections</code>, максимальное количество допустимых подключений или <code class="language-plaintext highlighter-rouge">None</code> без ограничений (по умолчанию 100)</li>
  <li><code class="language-plaintext highlighter-rouge">keepalive_expiry</code>, ограничение по времени для неактивных соединений проверки активности в секундах или <code class="language-plaintext highlighter-rouge">None</code> для отсутствия ограничений (по умолчанию 5 с)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">limits</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Limits</span><span class="p">(</span><span class="n">max_keepalive_connections</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_connections</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Client</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="больше-опций">Больше опций</h3>

<ul>
  <li>отображение процесса загрузки с помощью [<a href="tqdm" title="Tqdm">tqdm</a>]</li>
  <li><code class="language-plaintext highlighter-rouge">.netrc</code> поддержка</li>
  <li>конфигурирование таймаутов</li>
  <li>Multipart file encoding</li>
  <li>Customizing authentication (собственная схема аутентификации, к примеру субкласс <code class="language-plaintext highlighter-rouge">httpx.Auth</code>)</li>
  <li>SSL certificates</li>
  <li>Custom Transports (пользовательский транспортный объект, который будет использоваться для отправки запросов)</li>
</ul>

<h2 id="async-support"><a href="https://www.python-httpx.org/async/">Async Support</a></h2>

<p>HTTPX предлагает стандартный синхронный API по умолчанию, но также дает вам возможность использовать асинхронный клиент, если вам это нужно.</p>

<p>Async — это модель параллелизма, которая намного эффективнее многопоточности и может обеспечить значительные преимущества в производительности и позволить использовать долговременные сетевые подключения, такие как WebSockets. Если вы работаете с асинхронной веб-платформой, вам также может понадобиться асинхронный клиент для отправки исходящих HTTP-запросов.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.example.com/'</span><span class="p">)</span>
<span class="p">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span>
<span class="o">&lt;</span><span class="n">Response</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Доступные методы:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.get(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.options(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.head(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.post(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.put(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.patch(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.delete(url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.request(method, url, ...)</code></li>
  <li><code class="language-plaintext highlighter-rouge">AsyncClient.send(request, ...)</code></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># opening client witn acync context manager
</span><span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="p">...</span>

<span class="c1"># alternative
</span><span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span>
<span class="p">...</span>
<span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">aclose</span><span class="p">()</span>

<span class="c1"># in a stream
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'https://www.example.com/'</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="p">...</span>     <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">aiter_bytes</span><span class="p">():</span>
</code></pre></div></div>

<p>HTTPX поддерживает [<a href="asyncio" title="Asyncio">asyncio</a>] или [<a href="trio" title="Trio асинхронный фреймворк">trio</a>] в качестве асинхронной среды. Он автоматически определит, какой из них использовать в качестве бэкэнда для операций сокетов и примитивов параллелизма.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">httpx</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.example.com/'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">import</span> <span class="nn">trio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.example.com/'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">trio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div></div>

<p>Можно использовать [<a href="anyio" title="AnyIO асинхронный бекенд на базе asyncio и trio">AnyIO</a>], который поддерживает обе либы.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">import</span> <span class="nn">anyio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.example.com/'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">anyio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s">'trio'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="вызов-веб-приложений-python">Вызов веб-приложений Python</h3>

<p>Точно так же, как <code class="language-plaintext highlighter-rouge">httpx.Client</code> позволяет напрямую обращаться к веб-приложениям WSGI, класс <code class="language-plaintext highlighter-rouge">httpx.AsyncClient</code> позволяет напрямую обращаться к веб-приложениям ASGI, что полезно для тестов.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">starlette.applications</span> <span class="kn">import</span> <span class="n">Starlette</span>
<span class="kn">from</span> <span class="nn">starlette.responses</span> <span class="kn">import</span> <span class="n">HTMLResponse</span>
<span class="kn">from</span> <span class="nn">starlette.routing</span> <span class="kn">import</span> <span class="n">Route</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HTMLResponse</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Starlette</span><span class="p">(</span><span class="n">routes</span><span class="o">=</span><span class="p">[</span><span class="n">Route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">hello</span><span class="p">)])</span>


<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">httpx</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s">"http://testserver"</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<span class="p">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="p">...</span>     <span class="k">assert</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<span class="p">...</span>     <span class="k">assert</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">"Hello World!"</span>
</code></pre></div></div>

<h2 id="http2-support"><a href="https://www.python-httpx.org/http2/">HTTP2 support</a></h2>

<p>Смотри еще:</p>

<ul>
  <li><a href="https://www.python-httpx.org/">документация</a></li>
  <li><a href="https://github.com/aio-libs/aiohttp">github</a></li>
  <li>[<a href="asyncio" title="Asyncio">asyncio</a>]</li>
  <li>[<a href="trio" title="Trio асинхронный фреймворк">trio</a>]</li>
  <li>[<a href="requests" title="Requests">requests</a>]</li>
  <li>[<a href="aiohttp" title="Aiohttp асинхронный клиент-свервер на python.">aiohttp</a>]</li>
  <li>[<a href="anyio" title="AnyIO асинхронный бекенд на базе asyncio и trio">AnyIO</a>]</li>
  <li>[<a href="../lists/http" title="Http">http</a>]</li>
</ul>


  </div>
</article>


    </main>

    <footer role="banner">
<div class="border-top-thin clearfix mt-2 mt-lg-4">
    <div class="container mx-auto px-2">
      <p class="col-8 sm-width-full left py-2 mb-0"><a href="/myknowlegebase/">My knowledge base</a> проект поддерживается <a class="text-accent" href="https://github.com/KonstantinKlepikov">KonstantinKlepikov</a></p>
      <ul class="list-reset right clearfix sm-width-full py-2 mb-2 mb-lg-0">
        <li class="inline-block mr-1">
          <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="My knowledge base">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        </li>
      </ul>
    </div>
  </div>
</footer>

  </body>

</html>

<script type="text/javascript">
  // Hack: Replace page-link with "Page Title"
  document.querySelectorAll(".markdown-body a[title]").forEach((a) => {
    a.innerText = a.title;
  });
  // Hack: Remove .md extension from wikilinks to get the html in jekyll
  document.querySelectorAll("a").forEach(l => {
    if (l.href.endsWith('.md')) {
      l.href = l.href.substring(0, l.href.length-3)
    }
  })
</script>