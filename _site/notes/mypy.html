<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Mypy | My knowlege base</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Mypy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения" />
<meta property="og:description" content="Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения" />
<meta property="og:site_name" content="My knowlege base" />
<script type="application/ld+json">
{"@type":"WebPage","url":"/notes/mypy.html","headline":"Mypy","description":"Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=9dfbfccfe9b4d6a5d40a395bcc1c9d05cdad1bb1">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->


<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- Canonical and feed -->
<link rel="canonical" href="/notes/mypy.html">
<link rel="alternate" type="application/rss+xml" title="My knowlege base" href="/feed.xml">

<!-- Math support -->
<!-- Mathjax Support -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->
  </head>
  <body>

    <header class="page-header" role="banner">
      <h1 class="project-name">My knowlege base</h1>
      <h2 class="project-tagline">Мои заметки о программировании, data science и алгоритмах, собранные в процессе обучения</h2>
      <p class="project-tagline">Блог автора: <a class="project-tagline header-links" href="https://konstantinklepikov.github.io/">My deep learning</a></p>
    </header>

    <main id="content" class="main-content" role="main">
      <p><a href="/">На главную</a></p>
    
      <h1 id="mypy">Mypy</h1>

<p>[<a href="type-annotation" title="Анотация типов в python">type-annotation</a>] в python3.x и python 2.7. Используется в [<a href="pydantic" title="Pydantic">pydantic</a>] и, как следствие в [<a href="../lists/fastapi" title="Аastapi">fastapi</a>]</p>

<p><a href="https://mypy.readthedocs.io/en/stable/">Документация</a></p>

<p>Чек типов с крипте</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mypy program.py
<span class="c"># or </span>
mypy <span class="nt">--py2</span> program.py
</code></pre></div></div>

<h2 id="примеры-добавления-сигнатур">Примеры добавления сигнатур</h2>

<p>Типы данных, возвращаемых ф-ией</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">p</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'hello'</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="p">()</span>  <span class="c1"># Error: "p" does not return a value
</span></code></pre></div></div>

<p>Убедись, что включил анотацию <code class="language-plaintext highlighter-rouge">None</code>: если этого не сделать, функция может быть типизирована динамически.</p>

<p>Анотация аргументов</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greeting</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">excited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">'Hello, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">excited</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s">'!!!'</span>
    <span class="k">return</span> <span class="n">message</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">stars</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># 'args' has type 'Tuple[int, ...]' (a tuple of ints)
</span>    <span class="c1"># 'kwargs' has type 'Dict[str, float]' (a dict of strs to floats)
</span>    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<p>Дополнительные типы и модуль [<a href="typing" title="Typing">typing</a>]</p>

<p>В python 3.9 b можно типизировать, базируюся на стандартных типах, чтобы типизировать сложные объекты.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greet_all</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Hello '</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Alice"</span><span class="p">,</span> <span class="s">"Bob"</span><span class="p">,</span> <span class="s">"Charlie"</span><span class="p">]</span>
<span class="n">ages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

<span class="n">greet_all</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>   <span class="c1"># Ok!
</span><span class="n">greet_all</span><span class="p">(</span><span class="n">ages</span><span class="p">)</span>    <span class="c1"># Error due to incompatible types
</span></code></pre></div></div>

<p>В питоне 3.8 и младше необходимо импортировать модуль [<a href="typing" title="Typing">typing</a>]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>  <span class="c1"># Python 3.8 and earlier
</span>
<span class="k">def</span> <span class="nf">greet_all</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Hello '</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>Кроме того, можно использовать <code class="language-plaintext highlighter-rouge">abc</code>, например <code class="language-plaintext highlighter-rouge">collections.abc.Iterable</code> для python3.8 и младше</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>  <span class="c1"># or "from typing import Iterable"
</span>
<span class="k">def</span> <span class="nf">greet_all</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Hello '</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>Кроме того, из [<a href="typing" title="Typing">typing</a>] можно использовать специальные типы, реализующие логики и/или</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="k">def</span> <span class="nf">normalize_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'user-{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="mi">100000</span> <span class="o">+</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user_id</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">greeting</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># Optional[str] means the same thing as Union[str, None]
</span>    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">'stranger'</span>
    <span class="k">return</span> <span class="s">'Hello, '</span> <span class="o">+</span> <span class="n">name</span>
</code></pre></div></div>

<h2 id="type-cheet-sheets"><a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html">Type cheet sheets</a></h2>

<h3 id="variables">Variables</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is how you declare the type of a variable type in Python 3.6
</span><span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># In Python 3.5 and earlier you can use a type comment instead
# (equivalent to the previous definition)
</span><span class="n">age</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># type: int
</span>
<span class="c1"># You don't need to initialize a variable to annotate it
</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Ok (no value at runtime until assigned)
</span>
<span class="c1"># The latter is useful in conditional branches
</span><span class="n">child</span><span class="p">:</span> <span class="nb">bool</span>
<span class="k">if</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
    <span class="n">child</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">child</span> <span class="o">=</span> <span class="bp">False</span>
</code></pre></div></div>

<h3 id="built-in-types">Built-in types</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># For simple built-in types, just use the name of the type
</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"test"</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="s">b"test"</span>

<span class="c1"># For collections, the type of the collection item is in brackets
# (Python 3.9+)
</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">}</span>

<span class="c1"># In Python 3.8 and earlier, the name of the collection type is
# capitalized, and the type is imported from 'typing'
</span><span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">x</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">}</span>

<span class="c1"># Same as above, but with type comment syntax (Python 3.5 and earlier)
</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># type: List[int]
</span>
<span class="c1"># For mappings, we need the types of both keys and values
</span><span class="n">x</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'field'</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>  <span class="c1"># Python 3.9+
</span><span class="n">x</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'field'</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

<span class="c1"># For tuples of fixed size, we specify the types of all the elements
</span><span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"yes"</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">)</span>  <span class="c1"># Python 3.9+
</span><span class="n">x</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"yes"</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">)</span>

<span class="c1"># For tuples of variable size, we use one type and ellipsis
</span><span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Python 3.9+
</span><span class="n">x</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Use Optional[] for values that could be None
</span><span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_function</span><span class="p">()</span>
<span class="c1"># Mypy understands a value can't be None in an if-statement
</span><span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">upper</span><span class="p">())</span>
<span class="c1"># If a value can never be None due to some invariants, use an assert
</span><span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">upper</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="functions">Functions</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># This is how you annotate a function definition
</span><span class="k">def</span> <span class="nf">stringify</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

<span class="c1"># And here's how you specify multiple arguments
</span><span class="k">def</span> <span class="nf">plus</span><span class="p">(</span><span class="n">num1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">num1</span> <span class="o">+</span> <span class="n">num2</span>

<span class="c1"># Add default value for an argument after the type annotation
</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">num1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">my_float</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">num1</span> <span class="o">+</span> <span class="n">my_float</span>

<span class="c1"># This is how you annotate a callable (function) value
</span><span class="n">x</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>

<span class="c1"># A generator function that yields ints is secretly just a function that
# returns an iterator of ints, so that's how we annotate it
</span><span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># You can of course split a function annotation over multiple lines
</span><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
               <span class="n">sender</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">cc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
               <span class="n">bcc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
               <span class="n">subject</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
               <span class="n">body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
               <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="p">...</span>

<span class="c1"># An argument can be declared positional-only by giving it a name
# starting with two underscores:
</span><span class="k">def</span> <span class="nf">quux</span><span class="p">(</span><span class="n">__x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">quux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Fine
</span><span class="n">quux</span><span class="p">(</span><span class="n">__x</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Error
</span></code></pre></div></div>

<h3 id="when-youre-puzzled-or-when-things-are-complicated">When you’re puzzled or when things are complicated</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">cast</span>

<span class="c1"># To find out what type mypy infers for an expression anywhere in
# your program, wrap it in reveal_type().  Mypy will print an error
# message with the type; remove it again before running the code.
</span><span class="n">reveal_type</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># -&gt; Revealed type is "builtins.int"
</span>
<span class="c1"># Use Union when something could be one of a few types
</span><span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="s">"fun"</span><span class="p">]</span>

<span class="c1"># Use Any if you don't know the type of something or it's too
# dynamic to write a type for
</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">mystery_function</span><span class="p">()</span>

<span class="c1"># If you initialize a variable with an empty container or "None"
# you may have to help mypy a bit by providing a type annotation
</span><span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># This makes each positional arg and each keyword arg a "str"
</span><span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">do_api_query</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="c1"># Use a "type: ignore" comment to suppress errors on a given line,
# when your code confuses mypy or runs into an outright bug in mypy.
# Good practice is to comment every "ignore" with a bug link
# (in mypy, typeshed, or your own code) or an explanation of the issue.
</span><span class="n">x</span> <span class="o">=</span> <span class="n">confusing_function</span><span class="p">()</span>  <span class="c1"># type: ignore  # https://github.com/python/mypy/issues/1167
</span>
<span class="c1"># "cast" is a helper function that lets you override the inferred
# type of an expression. It's only for mypy -- there's no runtime check.
</span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">a</span><span class="p">)</span>  <span class="c1"># Passes fine
</span><span class="n">c</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">a</span><span class="p">)</span>  <span class="c1"># Passes fine (no runtime check)
</span><span class="n">reveal_type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1"># -&gt; Revealed type is "builtins.list[builtins.str]"
</span><span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1"># -&gt; [4]; the object is not cast
</span>
<span class="c1"># If you want dynamic attributes on your class, have it override "__setattr__"
# or "__getattr__" in a stub or in your source code.
#
# "__setattr__" allows for dynamic assignment to names
# "__getattr__" allows for dynamic access to names
</span><span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="c1"># This will allow assignment to any A.x, if x is the same type as "value"
</span>    <span class="c1"># (use "value: Any" to allow arbitrary types)
</span>    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span> <span class="p">...</span>

    <span class="c1"># This will allow access to any A.x, if x is compatible with the return type
</span>    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="p">...</span>

<span class="n">a</span><span class="p">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">42</span>  <span class="c1"># Works
</span><span class="n">a</span><span class="p">.</span><span class="n">bar</span> <span class="o">=</span> <span class="s">'Ex-parrot'</span>  <span class="c1"># Fails type checking
</span></code></pre></div></div>

<h3 id="standard-duck-types">Standard “duck types”</h3>

<p>In typical Python code, many functions that can take a list or a dict as an argument only need their argument to be somehow “list-like” or “dict-like”. A specific meaning of “list-like” or “dict-like” (or something-else-like) is called a “duck type”, and several duck types that are common in idiomatic Python are standardized.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span>

<span class="c1"># Use Iterable for generic iterables (anything usable in "for"),
# and Sequence where a sequence (supporting "len" and "__getitem__") is
# required
</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">ints</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ints</span><span class="p">]</span>

<span class="n">f</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Mapping describes a dict-like object (with "__getitem__") that we won't
# mutate, and MutableMapping one (with "__setitem__") that we might
</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">my_mapping</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">my_mapping</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s">'maybe'</span>  <span class="c1"># if we try this, mypy will throw an error...
</span>    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">my_mapping</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">f</span><span class="p">({</span><span class="mi">3</span><span class="p">:</span> <span class="s">'yes'</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">'no'</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">my_mapping</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">my_mapping</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s">'maybe'</span>  <span class="c1"># ...but mypy is OK with this.
</span>    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">my_mapping</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>

<span class="n">f</span><span class="p">({</span><span class="mi">3</span><span class="p">:</span> <span class="s">'yes'</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">'no'</span><span class="p">})</span>
</code></pre></div></div>

<p><a href="https://mypy.readthedocs.io/en/stable/protocols.html#protocol-types">Структурированные сабтипы</a></p>

<h3 id="classes">Classes</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
    <span class="c1"># You can optionally declare instance variables in the class body
</span>    <span class="n">attr</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1"># This is an instance variable with a default value
</span>    <span class="n">charge_percent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># The "__init__" method doesn't return anything, so it gets return
</span>    <span class="c1"># type "None" just like any other method that doesn't return anything
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="p">...</span>

    <span class="c1"># For instance methods, omit type for "self"
</span>    <span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">str1</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span> <span class="o">*</span> <span class="n">str1</span>

<span class="c1"># User-defined classes are valid as types in annotations
</span><span class="n">x</span><span class="p">:</span> <span class="n">MyClass</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>

<span class="c1"># You can use the ClassVar annotation to declare a class variable
</span><span class="k">class</span> <span class="nc">Car</span><span class="p">:</span>
    <span class="n">seats</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">passengers</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="c1"># You can also declare the type of an attribute in "__init__"
</span><span class="k">class</span> <span class="nc">Box</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></div>

<h3 id="coroutines-and-asyncio">Coroutines and asyncio</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="c1"># A coroutine is typed like a normal function
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">countdown35</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'T-minus {} ({})'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s">"Blastoff!"</span>
</code></pre></div></div>

<p><a href="https://mypy.readthedocs.io/en/stable/more_types.html#async-and-await">Подробнее</a></p>

<h3 id="miscellaneous">Miscellaneous</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Match</span><span class="p">,</span> <span class="n">AnyStr</span><span class="p">,</span> <span class="n">IO</span>

<span class="c1"># "typing.Match" describes regex matches from the re module
</span><span class="n">x</span><span class="p">:</span> <span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="s">r'[0-9]+'</span><span class="p">,</span> <span class="s">"15"</span><span class="p">)</span>

<span class="c1"># Use IO[] for functions that should accept or return any
# object that comes from an open() call (IO[] does not
# distinguish between reading, writing or other modes)
</span><span class="k">def</span> <span class="nf">get_sys_IO</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">'w'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IO</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'w'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'r'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span>

<span class="c1"># Forward references are useful if you want to reference a class before
# it is defined
</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># This will fail
</span>    <span class="p">...</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="p">...</span>

<span class="c1"># If you use the string literal 'A', it will pass as long as there is a
# class of that name later on in the file
</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="s">'A'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>  <span class="c1"># Ok
</span></code></pre></div></div>

<h3 id="decorators">Decorators</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="n">F</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'F'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Callable</span><span class="p">[...,</span> <span class="n">Any</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">bare_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="p">:</span>
    <span class="p">...</span>

<span class="k">def</span> <span class="nf">decorator_args</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">F</span><span class="p">],</span> <span class="n">F</span><span class="p">]:</span>
</code></pre></div></div>

<p><a href="https://mypy.readthedocs.io/en/stable/generics.html#declaring-decorators">Больше подробностей</a></p>

<h2 id="система-разметки-типов-подробнее">Система разметки типов подробнее</h2>

<ul>
  <li><a href="https://mypy.readthedocs.io/en/stable/generics.html#declaring-decorators">Встроенные типы</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/type_inference_and_annotations.html">Type inference and type annotations</a></li>
</ul>

<p>Mypy considers the initial assignment as the definition of a variable. If you do not explicitly specify the type of the variable, mypy infers the type based on the static type of the value expression</p>

<ul>
  <li><a href="https://mypy.readthedocs.io/en/stable/kinds_of_types.html">Дополнительные типы - разъяснение</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/class_basics.html">Аннотирование классов</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/runtime_troubles.html">Annotation issues at runtime</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/protocols.html">Protocols and structural subtyping</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/dynamic_typing.html">Dynamically typed code</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/casts.html">Casts and type assertions</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/duck_type_compatibility.html">Duck type compatibility</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/stubs.html">Stub files</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/generics.html">Generics</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/more_types.html">More types</a></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>

<span class="k">def</span> <span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'no way'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li><a href="https://mypy.readthedocs.io/en/stable/literal_types.html">Literal types</a></li>
  <li><a href="https://mypy.readthedocs.io/en/stable/final_attrs.html">Final names, methods and classes</a></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Final</span>

<span class="n">RATE</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="mi">3000</span>

<span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="n">DEFAULT_ID</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">RATE</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># Error: can't assign to final attribute
</span><span class="n">Base</span><span class="p">.</span><span class="n">DEFAULT_ID</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Error: can't override a final attribute
</span></code></pre></div></div>

<ul>
  <li><a href="https://mypy.readthedocs.io/en/stable/metaclasses.html">Metaclasses</a></li>
</ul>

<p>Остальное в доке про запуск <code class="language-plaintext highlighter-rouge">mypy</code> и разлисные вопросы работы/интеграции.</p>



<script type="text/javascript">
  // Hack: Replace page-link with "Page Title"
  document.querySelectorAll(".markdown-body a[title]").forEach((a) => {
    a.innerText = a.title;
  });
  // Hack: Remove .md extension from wikilinks to get the html in jekyll
  document.querySelectorAll("a").forEach(l => {
    if (l.href.endsWith('.md')) {
      l.href = l.href.substring(0, l.href.length-3)
    }
  })
</script>
      
      <p><a href="/">На главную</a></p>

      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/KonstantinKlepikov/myknowlegebase">myknowlegebase</a> поддерживается <a href="https://github.com/KonstantinKlepikov">KonstantinKlepikov</a></span>
        
        <span class="site-footer-credits">Блог автора: <a href="https://konstantinklepikov.github.io/">My deep learning</a></span>
      </footer>
    </main>
  </body>
</html>